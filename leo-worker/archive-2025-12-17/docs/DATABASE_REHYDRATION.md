# Database Rehydration for Generated Apps

Generated apps include everything needed to fully restore the database schema and seed data on a fresh Supabase project. This enables **truly ephemeral databases** for Fly.io or any deployment.

## What's Included in Generated Apps

| File | Purpose |
|------|---------|
| `drizzle/0000_*.sql` | Full SQL migration for all tables, indexes, and constraints |
| `drizzle.config.ts` | Drizzle Kit configuration |
| `supabase/seed.ts` | Demo users for both `auth.users` and `public.users` |
| `package.json` scripts | `db:push`, `db:seed`, `db:migrate` |

## Rehydration Workflow

When deploying to a new environment or switching Supabase projects:

```bash
# 1. Update .env with new Supabase credentials
#    - SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
#    - DATABASE_URL (port 5432 - for migrations)
#    - DATABASE_URL_POOLING (port 6543 - for runtime)

# 2. Apply schema to fresh database
npm run db:push

# 3. Seed demo users (creates users in both auth.users and public.users)
npm run db:seed

# 4. Verify
npm run dev
```

## Seed Users

The seed script creates demo users with these credentials:

| Email | Password | Role |
|-------|----------|------|
| `john@app.com` | `Demo2025_` | user |
| `admin@app.com` | `Demo2025_` | admin |

**Note**: These users are created in BOTH:
- `auth.users` (Supabase Auth - handles login)
- `public.users` (App schema - stores user profile data)

## Fly.io Deployment

For Fly.io deployments where the database is ephemeral:

1. **First deploy**: Run migrations and seed as part of release command
2. **Subsequent deploys**: Migrations are idempotent (safe to re-run)

Example `fly.toml` release command:
```toml
[deploy]
  release_command = "npm run db:push && npm run db:seed"
```

## Switching Supabase Projects

To migrate to a new Supabase project:

1. Create new Supabase project (via MCP tool or dashboard)
2. Copy new credentials to `.env`
3. Run `npm run db:push` to apply schema
4. Run `npm run db:seed` for demo users
5. Update any external services with new URLs

**Data Migration**: If you need to preserve existing data, export from old project first using `pg_dump` or Supabase dashboard export.

## How It Works

### Drizzle Migrations

The `drizzle/` folder contains SQL migrations generated by Drizzle Kit:
- `npm run db:push` - Pushes schema directly (dev/simple deploys)
- `npm run db:migrate` - Runs migration files (production with history)

### Seed Script

The `supabase/seed.ts` script:
1. Connects to Supabase using service role key
2. Creates users in `auth.users` via Supabase Admin API
3. Creates matching records in `public.users` table
4. Handles "user already exists" gracefully (idempotent)

### Environment Variables Required

```bash
# Supabase API (for auth and client SDK)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# Database connections
DATABASE_URL=postgresql://...@db.xxx.supabase.co:5432/postgres          # Direct - migrations
DATABASE_URL_POOLING=postgresql://...@pooler.supabase.com:6543/postgres  # Pooled - runtime
```
