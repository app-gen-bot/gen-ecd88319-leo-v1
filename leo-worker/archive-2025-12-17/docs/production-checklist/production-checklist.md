# Production Deployment Checklist for fly.io + Supabase Apps

> **Purpose**: Pre-deployment verification checklist for full-stack TypeScript applications using Vite, Express, Supabase, and fly.io. This checklist prevents common production issues and ensures secure, performant deployments.

> **Target**: All apps generated by the app-generator pipeline

---

## üìã Quick Reference

**Before every deployment, verify ALL items marked with ‚úÖ**

**Estimated Time**: 15-20 minutes for complete verification

---

## 1Ô∏è‚É£ Environment Configuration

### Backend Environment Variables
- ‚úÖ **Supabase Configuration**
  - [ ] `SUPABASE_URL` set via `flyctl secrets`
  - [ ] `SUPABASE_ANON_KEY` set via `flyctl secrets`
  - [ ] `SUPABASE_SERVICE_ROLE_KEY` set via `flyctl secrets` (NEVER in client code)
  - Verify: `flyctl secrets list --app <app-name>`

- ‚úÖ **AI Service Keys**
  - [ ] `ANTHROPIC_API_KEY` set via `flyctl secrets`
  - [ ] API key format validated (starts with `sk-ant-`)
  - Verify: `flyctl secrets list --app <app-name>`

- ‚úÖ **Application Configuration**
  - [ ] `NODE_ENV=production` set
  - [ ] `PORT` configured (default 8080 for fly.io)
  - [ ] `AUTH_MODE=supabase` set for production
  - [ ] `STORAGE_MODE=supabase` set for production

### Frontend Environment Variables
- ‚úÖ **API Configuration**
  - [ ] `VITE_API_URL` points to production domain (e.g., `https://myapp.fly.dev`)
  - [ ] NO trailing slash in `VITE_API_URL`
  - Verify after build: `grep -r "VITE_API_URL" dist/` should show production URL

- ‚úÖ **Supabase Client Configuration**
  - [ ] `VITE_SUPABASE_URL` set to production Supabase project
  - [ ] `VITE_SUPABASE_ANON_KEY` set (safe to expose with RLS)
  - Verify after build: `grep -r "VITE_SUPABASE" dist/` shows correct values

---

## 2Ô∏è‚É£ Build Verification

- ‚úÖ **TypeScript Compilation**
  - [ ] `npm run typecheck` passes with 0 errors
  - Command: `npm run typecheck`

- ‚úÖ **Linting** (Optional - if configured)
  - [ ] `npm run lint` passes (or warnings only, no errors)
  - [ ] If not configured, consider adding ESLint for code quality
  - Command: `npm run lint` or skip if not configured

- ‚úÖ **Production Build**
  - [ ] `npm run build` completes successfully
  - [ ] Build output in `dist/` directory created
  - [ ] TypeScript path aliases work with tsx runtime in production
  - Note: `@shared/*` imports work if tsconfig paths are configured, but relative paths are more reliable
  - Verify: `npm run build` succeeds without module resolution errors

- ‚úÖ **Bundle Size**
  - [ ] Frontend bundle < 500KB gzipped (check Vite build output)
  - [ ] Raw bundle < 1.5MB uncompressed
  - [ ] No large dependencies accidentally included
  - Verify: Check output of `npm run build` - look for "gzip" sizes

---

## 3Ô∏è‚É£ Database & Backend

- ‚úÖ **Supabase Configuration**
  - [ ] Row Level Security (RLS) enabled on all tables
  - [ ] RLS policies tested for all user roles
  - [ ] Database migrations applied (if using migrations)
  - Verify: Check Supabase dashboard ‚Üí Authentication ‚Üí Policies

- ‚úÖ **API Endpoints**
  - [ ] Health check endpoint `/api/health` returns 200
  - [ ] All protected endpoints require authentication
  - [ ] Error responses return proper HTTP status codes (401, 403, 404, 500)
  - Test locally: `curl http://localhost:5013/api/health`

- ‚úÖ **Database Connections**
  - [ ] Connection pooling configured (Supavisor or pgBouncer)
  - [ ] Connection limits set appropriately
  - [ ] SSL/TLS enabled for database connections

---

## 4Ô∏è‚É£ Frontend & API Integration

- ‚úÖ **API Client Configuration**
  - [ ] API client uses getter property for dynamic auth headers
  - [ ] Token stored in `localStorage` (not in state)
  - [ ] API base URL reads from `VITE_API_URL`
  - Verify: Check `client/src/lib/api-client.ts`

- ‚úÖ **Environment Variable Configuration**
  - [ ] Verify all VITE_ prefixed variables are set for client access
  - [ ] SUPABASE_URL and SUPABASE_ANON_KEY available to backend
  - [ ] If using Supabase client in frontend, ensure VITE_SUPABASE_* variables exist
  - Note: Vite only exposes variables with VITE_ prefix to client code

- ‚úÖ **CORS Configuration**
  - [ ] Production domain added to allowed origins array
  - [ ] Credentials enabled: `credentials: true`
  - [ ] Preflight requests handled correctly
  - [ ] ‚ö†Ô∏è Verify CORS doesn't allow ALL origins in production (security risk)
  - [ ] Avoid: `if (NODE_ENV === 'production') { callback(null, true) }`
  - Verify: Check `server/index.ts` CORS configuration restricts to specific domains

- ‚úÖ **Authentication Flow**
  - [ ] Login/signup redirects work correctly
  - [ ] Protected routes redirect to login when unauthenticated
  - [ ] Token refresh implemented (if using JWT)
  - [ ] Logout clears all auth state

- ‚úÖ **Static File Serving**
  - [ ] Static files served from `dist/` in production
  - [ ] SPA fallback configured (all non-API routes ‚Üí `index.html`)
  - [ ] Static files served BEFORE protected routes
  - Verify: Check `server/index.ts` static file middleware order

---

## 5Ô∏è‚É£ Security Audit

- ‚úÖ **Secrets Management**
  - [ ] NO `.env` files committed to git
  - [ ] NO API keys in client-side code
  - [ ] All secrets set via `flyctl secrets set`
  - Verify: `git log --all --full-history -- .env` should be empty

- ‚úÖ **API Security**
  - [ ] All sensitive endpoints protected by auth middleware
  - [ ] Input validation on all POST/PUT endpoints
  - [ ] SQL injection prevention (using parameterized queries)
  - [ ] Rate limiting configured (if applicable)

- ‚úÖ **Supabase Security**
  - [ ] Service role key NEVER exposed to client
  - [ ] RLS policies enforce user isolation
  - [ ] Anon key used in client (safe with RLS)
  - Verify: `grep -r "SERVICE_ROLE" client/` should return nothing

- ‚úÖ **Docker Image Security**
  - [ ] NO secrets in Dockerfile
  - [ ] `.dockerignore` excludes `.env`, `node_modules`, `.git`
  - [ ] Minimal base image (node:20-slim)
  - Verify: Check `.dockerignore` file exists

---

## 6Ô∏è‚É£ Performance Checks

- ‚úÖ **Frontend Performance**
  - [ ] Images optimized (using Unsplash URLs or compressed)
  - [ ] Lazy loading for heavy components
  - [ ] Minimize console.log statements in production (or wrap in dev-only conditions)
  - Verify: `grep -r "console.log" client/src/ | wc -l` - keep count low (<10 ideally)
  - Tip: Use `if (import.meta.env.DEV) console.log(...)` for dev-only logging

- ‚úÖ **Backend Performance**
  - [ ] Database queries optimized (indexes on foreign keys)
  - [ ] Connection pooling enabled
  - [ ] Graceful shutdown implemented (SIGTERM/SIGINT handlers)
  - Verify: Check `server/index.ts` for process.on handlers

- ‚úÖ **fly.io Configuration**
  - [ ] Memory limits set appropriately (1GB default)
  - [ ] CPU limits configured
  - [ ] Auto-stop machines enabled (for cost savings)
  - Verify: Check `fly.toml` resource limits

---

## 7Ô∏è‚É£ fly.io Deployment

- ‚úÖ **Pre-Deployment**
  - [ ] `fly.toml` configured with correct app name
  - [ ] HTTP health check endpoint configured (not just TCP)
  - [ ] Health check path points to `/api/health` and expects HTTP 200
  - [ ] Environment variables reviewed
  - Verify: Check `fly.toml` for `[[services.http_checks]]` section
  - Verify: `flyctl config show --app <app-name>`

- ‚úÖ **Deployment Execution**
  - [ ] Run `flyctl deploy --no-cache` for fresh build
  - [ ] Monitor deployment logs for errors
  - [ ] Wait for "Machine is now in a good state" message
  - Command: `flyctl deploy --no-cache --app <app-name>`

- ‚úÖ **Machine Configuration**
  - [ ] Health checks passing (1 total, 1 passing)
  - [ ] Machine state = "started"
  - [ ] Region configured appropriately
  - Verify: `flyctl status --app <app-name>`

---

## 8Ô∏è‚É£ Post-Deployment Verification

- ‚úÖ **Application Health**
  - [ ] Health endpoint returns 200: `curl https://<app-name>.fly.dev/api/health`
  - [ ] Response includes correct auth/storage mode (supabase)
  - [ ] Timestamp in response is recent

- ‚úÖ **Frontend Verification**
  - [ ] Root path loads: `curl -I https://<app-name>.fly.dev/`
  - [ ] Static assets load correctly
  - [ ] No console errors in browser
  - [ ] Mobile responsiveness verified

- ‚úÖ **API Functionality**
  - [ ] Login/signup flow works
  - [ ] Protected endpoints require authentication
  - [ ] Database queries return correct data
  - [ ] AI features respond correctly (if applicable)

- ‚úÖ **Error Handling**
  - [ ] 404 pages display correctly
  - [ ] API errors return proper status codes
  - [ ] Error messages user-friendly (no stack traces exposed)

- ‚úÖ **Monitoring Setup**
  - [ ] Application logs accessible: `flyctl logs --app <app-name>`
  - [ ] Error tracking configured (if using Sentry, etc.)
  - [ ] Performance monitoring active

---

## 9Ô∏è‚É£ Rollback Plan

**If deployment fails or issues are detected:**

1. **Immediate Rollback**
   ```bash
   flyctl releases list --app <app-name>
   flyctl releases rollback <version> --app <app-name>
   ```

2. **Verify Rollback**
   ```bash
   flyctl status --app <app-name>
   curl https://<app-name>.fly.dev/api/health
   ```

3. **Investigate Issue**
   - Check logs: `flyctl logs --app <app-name>`
   - Review recent changes: `git log`
   - Test locally with production environment variables

4. **Fix and Redeploy**
   - Fix issue in code
   - Re-run this checklist
   - Deploy with `--no-cache` flag

---

## üîß Common Issues & Solutions

### Issue: Machine keeps restarting
- **Cause**: Health check endpoint failing
- **Solution**: Verify `/api/health` returns 200, check for startup errors in logs

### Issue: TypeScript path alias errors in production
- **Cause**: tsx runtime doesn't resolve `@shared/*` aliases
- **Solution**: Use relative paths with `.js` extensions in server code

### Issue: 401 errors on all API calls
- **Cause**: CORS misconfiguration or incorrect API URL
- **Solution**: Verify `VITE_API_URL` in built frontend, check CORS origins

### Issue: Database connection failures
- **Cause**: Missing environment variables or RLS blocking queries
- **Solution**: Verify Supabase secrets, test RLS policies in Supabase dashboard

### Issue: "Module not found" errors
- **Cause**: Relative imports incorrect or missing `.js` extensions
- **Solution**: Use relative paths with `.js` extensions for ESM compatibility

### Issue: Position mapping bugs in poker games
- **Cause**: Incorrect seat-to-position logic in heads-up scenarios
- **Solution**: Verify position mapping follows standard poker rules (dealer=BTN, non-dealer=BB)

### Issue: VITE_ environment variables not accessible in client
- **Cause**: Vite only exposes variables prefixed with `VITE_` to client code
- **Solution**: Rename client-side variables to `VITE_SUPABASE_URL`, `VITE_API_URL`, etc.
- **Check**: Search for `import.meta.env.SUPABASE_URL` and replace with `import.meta.env.VITE_SUPABASE_URL`

### Issue: Mobile UI rendering issues
- **Cause**: Fixed widths or missing responsive breakpoints
- **Solution**: Use responsive Tailwind classes, test on mobile viewports

---

## üìö Additional Resources

- **fly.io Documentation**: https://fly.io/docs/
- **Supabase Documentation**: https://supabase.com/docs
- **Vite Production Build**: https://vitejs.dev/guide/build.html
- **Express Security Best Practices**: https://expressjs.com/en/advanced/best-practice-security.html

---

## ‚úÖ Final Pre-Deployment Checklist

**Before clicking deploy, confirm:**

- [ ] All environment variables verified
- [ ] `npm run typecheck && npm run build` succeeds
- [ ] TypeScript path aliases work with tsx runtime
- [ ] Security audit passed (no exposed secrets)
- [ ] `flyctl secrets list` shows all required secrets
- [ ] `fly.toml` HTTP health check endpoint configured
- [ ] CORS restricts to production domain (not all origins)
- [ ] Supabase RLS policies tested

**Time to deploy!** üöÄ

```bash
flyctl deploy --no-cache --app <app-name>
```

---

*Last Updated: 2025-10-26*
*Version: 1.1*
*For: App-Generator Pipeline (fly.io + Supabase stack)*
