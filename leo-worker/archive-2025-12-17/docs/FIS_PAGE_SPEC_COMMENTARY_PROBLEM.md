# FIS Page Spec Commentary Problem - Deep Dive Analysis

**Date**: January 2025
**Severity**: CRITICAL - Blocks page generation
**Status**: Identified, fix designed

## Problem Statement

The FISPageAgent is generating **agent commentary** about the specification instead of the **actual specification document**. This renders the page specs unusable by downstream page generator agents.

## Evidence

### Example 1: HomePage.md (NEW - BROKEN)

```markdown
I'll create a detailed specification for the HomePage based on the master spec, API registry, schema, and complete page list.

Perfect! I've created a comprehensive and detailed specification for the **HomePage** at route `/`. Here's what the specification includes:

## Summary of HomePage Specification

### 1. **Page Setup**
- Route: `/`
- Layout: Standard Layout (header, main content, footer)
- Purpose: Landing page to showcase chapels and guide booking flow

### 2. **Content Structure** (5 Major Sections)
1. **Hero Section**: Large heading, subtitle, 2 CTA buttons
2. **Featured Chapels**: Grid of 4 highest-rated chapel cards
...
```

**Analysis**: This is a SUMMARY or COVER LETTER, not a spec. The agent is explaining what it generated instead of generating it.

### Example 2: MyChapelsPage.md (OLD - CORRECT)

```markdown
# Frontend Interaction Specification - My Chapels Page

**Route**: `/dashboard/owner/chapels`
**Layout**: Dashboard Layout (Template 2)
**Role**: Chapel Owner (Protected)
**Purpose**: Display all chapels owned by the authenticated chapel owner

---

## 1. Page Setup

**Layout**: Dashboard Layout from master spec
- Fixed header with logo, "Dashboard" link, and profile menu
- Fixed sidebar (240px) with navigation links
...

## 3. User Interactions

### Header Actions

| Element | Label | Type | Position | Trigger | Action |
|---------|-------|------|----------|---------|--------|
| Add Chapel Button | "+ Add New Chapel" | Button (Primary) | Top-right | Click | Navigate to `/dashboard/owner/chapels/new` |
...
```

**Analysis**: This is a SPECIFICATION DOCUMENT with structured sections, tables, code blocks, and concrete details.

## Root Cause Analysis

### 1. System Prompt Issues

**File**: `src/app_factory_leonardo_replit/agents/frontend_interaction_spec_page/system_prompt.py`

**Current Prompt** (lines 3-73):
```python
SYSTEM_PROMPT = """You are a Page Specification designer.
Create detailed specifications for individual pages using the master spec foundation.

## Your Inputs
1. Master specification - for design tokens, layouts, navigation map, API methods
2. API Registry (`client/src/lib/api-registry.md`) - ALL available API methods
3. Page name and route from master's navigation map

## Generate These Sections

### 1. Page Setup
- Name and route (must exist in master's navigation map)
- Which layout from master
- Purpose (one sentence)

### 2. Content Structure
Specific sections and arrangement:
- Hero with heading and subtitle
- Grid of cards/content
...
```

**Problems Identified**:

1. **No Output Format Directive**: Prompt says "Generate These Sections" but doesn't say "Output ONLY the markdown document"
2. **No Example Format**: No concrete example of what the output should look like
3. **No Anti-Commentary Instruction**: Doesn't explicitly say "Do not include commentary or explanations"
4. **Conversational Framing**: "You are a Page Specification designer" encourages conversational responses
5. **Missing Document Structure**: Doesn't specify the title format, header format, or markdown structure

### 2. Agent Configuration

**File**: `src/app_factory_leonardo_replit/agents/frontend_interaction_spec_page/config.py`

```python
AGENT_CONFIG = {
    "name": "Frontend Interaction Spec Page Generator",
    "model": "sonnet",
    "allowed_tools": ["Read", "Write", "Edit", "Grep", "Glob"],
    "max_turns": get_max_turns(10)
}
```

**Analysis**: Configuration is fine. The issue is purely prompt-driven.

### 3. Behavioral Analysis

The agent is exhibiting classic "conversational assistant" behavior:
- Opens with "I'll create..." (announcing intent)
- Closes with "Perfect! I've created..." (celebrating completion)
- Provides executive summary instead of deliverable
- Uses conversational markers ("Here's what the specification includes")

This suggests the agent interprets its role as "explaining what it did" rather than "generating the artifact directly."

## Impact Assessment

### Severity: CRITICAL

**Downstream Effects**:
1. **Page Generator Agents FAIL**: Cannot parse commentary as structured specs
2. **Pipeline Blocked**: Cannot generate actual page components
3. **Manual Intervention Required**: Humans must rewrite specs manually
4. **Option 3 Validation Blocked**: Cannot test full pipeline with fresh artifacts

### Scope

**Files Affected**: ALL page specs generated by FISPageAgent
- Found in: `apps/{workspace}/app/specs/pages/frontend-interaction-spec-*.md`
- Count: 8 files in option3-validation-test workspace (100% affected)

**Timeline**:
- **Old behavior** (pre-Option 3): Specs generated correctly (see MyChapelsPage.md example)
- **New behavior** (post-Option 3): Specs contain commentary instead of content
- **Trigger**: Unknown - possibly related to Option 3 changes or model behavior change

## Comparative Analysis

### What Changed Between Good and Bad Specs?

| Aspect | OLD (GOOD) | NEW (BAD) |
|--------|-----------|-----------|
| **First Line** | `# Frontend Interaction Specification - {PageName}` | `I'll create a detailed specification...` |
| **Structure** | Markdown headers, tables, code blocks | Narrative text with bullet summaries |
| **Content** | Concrete details (colors, sizes, routes) | Abstract descriptions ("Hero Section", "Grid of cards") |
| **Code Blocks** | TypeScript API call examples | None |
| **Tables** | User interaction tables with 6 columns | Narrative lists |
| **Agent Voice** | None (pure document) | Heavy ("Perfect!", "I've created") |

### Key Indicator

**GOOD SPEC**: Can be copy-pasted into implementation
**BAD SPEC**: Must be interpreted and translated into actionable details

## Fix Design

### Strategy 1: Explicit Output Format Instruction (RECOMMENDED)

**Changes Required**:

1. **Update System Prompt** (`system_prompt.py`)

```python
SYSTEM_PROMPT = """You are a technical documentation generator.

Generate a Frontend Interaction Specification document in pure markdown format.

## CRITICAL OUTPUT REQUIREMENTS

1. **Output ONLY the specification markdown**
2. **Do NOT include any commentary, explanations, or summaries**
3. **Do NOT start with "I'll create..." or end with "I've created..."**
4. **Do NOT explain what the spec contains - just write the spec itself**
5. **First line must be**: `# Frontend Interaction Specification - {PageName}`

## Required Document Structure

```markdown
# Frontend Interaction Specification - {PageName}

**Route**: `{route}`
**Layout**: {layout from master spec}
**Role**: {authentication requirements}
**Purpose**: {one sentence purpose}

---

## 1. Page Setup

{Concrete details about layout, authentication, redirects}

---

## 2. Content Structure

{Detailed sections with specific styling}

### {Section Name}
- Element: "{Label}" ({fontSize}, color {hex}, weight {weight})
- Element: "{Label}" ({styling details})

---

## 3. User Interactions

{Tables with every interactive element}

| Element | Label | Type | Position | Trigger | Action |
|---------|-------|------|----------|---------|--------|
| Button | "Click Me" | Button (Primary) | Top-right | Click | Navigate to `/route` |

---

## 4. API Integration

### On Page Load

```typescript
const { data, isLoading, error } = useQuery({
  queryKey: ['key'],
  queryFn: async () => {
    const response = await apiClient.namespace.method({ query: {} });
    return response.body;
  }
});
```

### On User Action

```typescript
const handleAction = async () => {
  const response = await apiClient.namespace.method({ body: {} });
};
```

---

## 5. States

### Loading State
{Concrete skeleton UI description}

### Empty State
{Exact icon, heading, message, button}

### Error State
{Exact error message, buttons}

### Success State
{Normal display details}

---

## 6. Visual Specifications

{CSS code blocks if needed}

---

## 7. Responsive Behavior

### Desktop (1024px+)
{Layout details}

### Tablet (768px - 1024px)
{Layout details}

### Mobile (0 - 768px)
{Layout details}

---

## 8. Accessibility

{ARIA labels, keyboard nav, focus indicators}

---

## 9. Edge Cases

{Numbered list of edge cases and handling}

---

**End of {PageName} Specification**
```

## Your Inputs

1. **Master Spec** - Design tokens, layouts, navigation map
2. **API Registry** - ALL available methods
3. **Database Schema** - Field names, types, validation
4. **Complete Page List** - All valid navigation routes
5. **Workflow Context** (optional) - Multi-step process info

## Generate Sections

{Rest of existing prompt with section details...}

## CRITICAL Rules

1. **Navigation**: ONLY use routes from Complete Page List
2. **API Methods**: ONLY use methods from API Registry
3. **Data Fields**: ONLY use fields from Database Schema
4. **Output Format**: Pure markdown document, no commentary
5. **Be Concrete**: Actual hex colors, pixel sizes, exact messages
"""
```

**Key Changes**:
1. ✅ Added "CRITICAL OUTPUT REQUIREMENTS" section at top
2. ✅ Explicit anti-commentary instructions
3. ✅ Complete example document structure
4. ✅ Changed role from "designer" to "technical documentation generator"
5. ✅ Emphasized "Output ONLY the specification markdown"

### Strategy 2: Add Example Spec to Prompt (ALTERNATIVE)

Include a full example spec in the system prompt as a reference.

**Pros**: Agent sees exact desired output
**Cons**: Very long prompt (2K+ tokens)

### Strategy 3: Two-Pass Generation (NOT RECOMMENDED)

1. First pass: Generate spec content
2. Second pass: Format as markdown

**Pros**: Separation of concerns
**Cons**: Slower, more expensive, complex orchestration

## Recommended Fix

**Use Strategy 1**: Update system prompt with explicit output format instructions

**Implementation Steps**:

1. Update `system_prompt.py` with new prompt
2. Run test generation on single page to validate
3. Compare output to expected format
4. If successful, run full pipeline
5. Validate all 8 page specs have correct format

## Testing Plan

### Test Case 1: Single Page Generation

```bash
# Generate single page spec manually
# Check output format matches expected structure
```

**Expected Output**:
- First line: `# Frontend Interaction Specification - TestPage`
- No commentary text
- Structured markdown with tables and code blocks
- Concrete details (colors, sizes, routes)

### Test Case 2: Full Pipeline

```bash
# Run full pipeline with new prompt
uv run python src/app_factory_leonardo_replit/run.py "test app" --workspace-name fix-validation

# Check all page specs
ls -la apps/fix-validation/app/specs/pages/

# Read sample specs
cat apps/fix-validation/app/specs/pages/frontend-interaction-spec-HomePage.md
```

**Success Criteria**:
- All specs start with `# Frontend Interaction Specification - {PageName}`
- No agent commentary ("I'll create", "Perfect!")
- Structured sections with markdown tables
- Code blocks for API calls
- Concrete styling details

### Test Case 3: Page Generator Integration

```bash
# Try to generate actual page from new spec
# Verify page generator can parse the spec
```

**Success Criteria**:
- Page generator successfully parses spec
- Generated component matches spec details
- No parsing errors or ambiguities

## Validation Metrics

### Before Fix (Current State)

- ❌ Spec format: Commentary/Summary
- ❌ Usability: Not parseable by page generator
- ❌ First line: "I'll create a detailed specification..."
- ❌ Structure: Narrative text with bullet points
- ❌ Code blocks: None
- ❌ Tables: None
- ❌ Concrete details: Abstract descriptions only

### After Fix (Expected State)

- ✅ Spec format: Structured markdown document
- ✅ Usability: Directly parseable by page generator
- ✅ First line: `# Frontend Interaction Specification - {PageName}`
- ✅ Structure: Markdown headers, tables, code blocks
- ✅ Code blocks: TypeScript examples for API calls
- ✅ Tables: User interaction tables with 6 columns
- ✅ Concrete details: Hex colors, pixel sizes, exact routes

## Risk Assessment

### Implementation Risks

**Low Risk**:
- Prompt change is non-breaking (agent still generates markdown)
- Can validate on single page before full pipeline
- Easy to revert if needed

**Medium Risk**:
- Agent might still inject some commentary despite instructions
- May need iterative prompt refinement

**Mitigation**:
- Test on single page first
- Have rollback plan (revert prompt change)
- Monitor agent output during generation

### Rollback Plan

If fix doesn't work:
1. Revert `system_prompt.py` to previous version
2. Try Strategy 2 (include example spec)
3. If both fail, investigate model behavior changes

## Timeline Estimate

- **Prompt Update**: 15 minutes
- **Single Page Test**: 5 minutes (1 generation cycle)
- **Full Pipeline Test**: 30-45 minutes (complete app generation)
- **Validation**: 15 minutes (review all specs)

**Total**: ~90 minutes to complete fix and validation

## Related Issues

### Issue 1: When Did This Break?

**Investigation Needed**: Compare old successful specs to determine:
- Was there a system prompt change?
- Did model behavior change?
- Is this related to Option 3 changes?

**Hypothesis**: The Option 3 changes to user_prompt.py might have inadvertently encouraged conversational responses by adding more context.

### Issue 2: Master Spec Quality

**Observation**: HomePage spec references master spec for design tokens, but master spec appears minimal (78 lines).

**Question**: Is the master spec also affected by similar commentary issues?

**Action**: Review master spec generation agent

## Conclusion

**Problem**: FISPageAgent generates commentary instead of specifications
**Root Cause**: System prompt lacks explicit output format instructions
**Fix**: Update system prompt with anti-commentary directives and example structure
**Impact**: CRITICAL - blocks entire page generation pipeline
**Confidence**: HIGH - fix is straightforward and testable
**Next Steps**: Implement Strategy 1 and validate

---

**Analysis completed**: 2025-01-12
**Document author**: Claude (AI Analysis)
**Validation status**: Awaiting implementation
