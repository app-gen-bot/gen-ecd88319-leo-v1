**Context**
- Leonardo pipeline runs from prompt → plan → UI/interaction specs → design system → preview → build/validator, with active work under `src/app_factory_leonardo_replit/` and shared agents in `src/cc_agent` (`CLAUDE.md:1` and `AGENTS.md:1`).
- Current stack targets Vite + Express + Drizzle, but several downstream prompts still mention legacy Next.js/Wouter expectations, creating guidance drift (`src/app_factory_leonardo_replit/agents/layout_generator/system_prompt.py:6` and `src/app_factory_leonardo_replit/agents/stage_2_wireframe_archived/wireframe/system_prompt.py:3`).
- Writer–critic loops enforce the “Never Broken” contract across stages, with critics returning minimal XML and builders required to ship green builds before continuing (`CLAUDE.md:90`).

**Design Guidance**
- 2025 best practices emphasize clarity, restraint, consistent tokens, accessibility (AA+), and lightweight performance across surfaces (`docs/design-best-practices/2025-design-best-practices.md:3`).
- Style direction favors flat+elevation hybrids with subtle glassmorphism accents, soft gradients, micro-interactions, and equal priority for dark mode, while warning against neon palettes and heavy blur (`docs/design-best-practices/2025-design-best-practices.md:16`).
- Typography guidance (Inter/SF/Geist, modular scale 1.125–1.2) and spacing grids (8px base, 12-col, generous whitespace) should anchor generated systems (`docs/design-best-practices/2025-design-best-practices.md:55`).
- Conversation notes translate the cheat sheet into AI-friendly prompting, highlighting semantic token naming (“venue-available”, “celebration-gold”), layered blurs, and motion timings (`docs/design-best-practices/ChatGPT-Conversation.md:15`).

**UX Pipeline**
- Stage 1 Interaction Spec ensures exhaustive journeys, navigation maps, and accessibility expectations feeding later design choices (`src/app_factory_leonardo_replit/agents/stage_1_interaction_spec/interaction_spec/system_prompt.py:1`).
- Stage 1 UI Component Spec positions the agent as a UX designer producing visual language and component behavior guidance, yet it doesn’t mention the 2025 rules or design-token schema expected by downstream stages (`src/app_factory_leonardo_replit/agents/stage_1_ui_component_spec/ui_component_spec/system_prompt.py:3`).
- Design System stage copies template files then uses a template-driven prompt; docs acknowledge the current keyword bucket approach and outline a richer, specs-driven alternative (`src/app_factory_leonardo_replit/stages/design_system_stage.py:1`, `src/app_factory_leonardo_replit/agents/design_system/docs/current-implementation.md:5`, `src/app_factory_leonardo_replit/agents/design_system/docs/specs-driven-approach.md:1`).
- Stage 2 wireframe prompt instructs creation of a production Next.js app with Heroicons/Unsplash, conflicting with the Vite template and lacking ties to the new best-practice palette/motion guidance (`src/app_factory_leonardo_replit/agents/stage_2_wireframe_archived/wireframe/system_prompt.py:3`).
- Build stage integrates generated design-system files into the Vite scaffold, so the quality of `design-system/tailwind.config.js`, `globals.css`, and `design-tokens.ts` propagates into the shipped app (`src/app_factory_leonardo_replit/stages/build_stage.py:455`).
- Preview generator and requirements doc enforce single-scroll previews and ShadCN usage but don’t remind agents to pull semantic tokens or 2025 styling motifs (`src/app_factory_leonardo_replit/agents/preview_generator/system_prompt.py:3`, `src/app_factory_leonardo_replit/agents/preview_generator/docs/PREVIEW_REQUIREMENTS.md:1`).
- Component/layout/main-page/app-shell generator prompts still assume `client/src` + Wouter routing, so they need alignment with the current Vite/Express project layout before layering new design guidance (`src/app_factory_leonardo_replit/agents/app_shell_generator/system_prompt.py:6` and `src/app_factory_leonardo_replit/agents/main_page_generator/system_prompt.py:6`).

**Recommendations**
- Update Stage 1 UI Component Spec prompts/config to embed the 2025 principles explicitly (tokens, spacing, motion, dark mode expectations) and output structured guidance consumable by the design-system agent (`src/app_factory_leonardo_replit/agents/stage_1_ui_component_spec/ui_component_spec/system_prompt.py:3` and `config.py:7`).
- Rework the design-system agent to follow the specs-driven approach: remove keyword template locking, add semantic scaffolding in base files, permit MultiEdit, and reference the cheat sheet within prompts (`src/app_factory_leonardo_replit/agents/design_system/user_prompt.py:119`, `docs/specs-driven-approach.md:31`).
- Align Stage 2 wireframe, preview generator, and downstream writer prompts with Vite + Tailwind conventions and the 2025 aesthetics, ensuring they read `ui-component-spec.md` as the primary visual contract before generating code (`src/app_factory_leonardo_replit/agents/stage_2_wireframe_archived/wireframe/system_prompt.py:47`, `src/app_factory_leonardo_replit/agents/preview_generator/system_prompt.py:25`).
- Refresh builder agents (layout/main/component/app shell) to the modern directory structure and enforce usage of generated design tokens, accent palette limits, and micro-interaction timings defined in the best-practices docs (`src/app_factory_leonardo_replit/agents/layout_generator/system_prompt.py:6`, `src/app_factory_leonardo_replit/agents/component_generator/system_prompt.py:1`).
- Document the agreed design playbook in the repo (e.g., `docs/design-best-practices/best-practice-plan.md`) and add smoke validation to ensure generated Tailwind configs expose required tokens and no placeholder strings remain (`src/app_factory_leonardo_replit/stages/design_system_stage.py:61`).

**Next Steps**
- Socialize this plan with the team, confirm priority ordering (design spec enrichment → design system refactor → downstream prompt refresh), and lock timelines.
- Prototype the design-system changes in a branch with one sample app, verifying that `ui-component-spec.md` → design system → preview all reflect the 2025 rules.
- Once prompts are updated, run `uv run pytest -v` plus a pipeline dry run (`uv run python src/app_factory_leonardo_replit/run.py "<prompt>"`) to confirm the Never Broken flow still passes.
- Capture before/after outputs in `apps/` as verification artifacts and add notes to `CLAUDE.md` or a new RFC documenting the new design guardrails.

**Pipeline Workflow Map**
1. `src/app_factory_leonardo_replit/run.py:16` calls `run_pipeline` in `main.py`, after preparing a workspace under `apps/<workspace>` and cleaning `app/` for fresh runs.
2. **Plan Stage** (`plan_stage.run_stage`) runs when `plan/plan.md` is missing, producing the application blueprint in `plan/plan.md` (`src/app_factory_leonardo_replit/main.py:111`).
3. **UI Component Spec Stage** (`stage_1_ui_component_spec.run_stage`) consumes the plan and writes `plan/ui-component-spec.md`, giving visual language guidance (`main.py:131`).
4. **Design System Stage** (`design_system_stage.run_stage`) copies template files into `design-system/` and customizes `tailwind.config.js`, `globals.css`, and `design-tokens.ts` using the UI component spec (`main.py:157`).
5. **Preview Stage** (`preview_stage.run_stage`) generates `preview-html/preview.html` and `preview-react/App.tsx`, producing the static ShadCN preview while referencing the design system (`main.py:185`).
6. **Build Stage** (`build_stage.run_stage`) extracts the Vite/Express template into `app/`, generates a technical spec (`app/specs/pages-and-routes.md`), then executes Writer–Critic loops for schema, storage, routes, API client, layout, context providers, app shell, main page, and additional pages/components (`main.py:205`, `stages/build_stage.py:455`).
7. **Validator Stage** (`validator_stage.run_validator_stage`) runs fixer/critic cycles in `app/`, requiring oxc/build/browser checks to pass before completion (`main.py:232`, `stages/validator_stage.py:1`).
8. `run_pipeline` returns immediately after validator handling, so downstream code (legacy Stage 1/Stage 2 logic) is unreachable (`main.py:250`).

**Unreached/Legacy Modules (Archived)**
- `src/app_factory_leonardo_replit/stages/stage_0_prd_archived.py` and `agents/stage_0_orchestrator_archived/*`: PRD generator superseded by the current plan stage; never invoked in `run_pipeline`.
- `src/app_factory_leonardo_replit/stages/stage_1_interaction_spec_archived.py` plus `agents/stage_1_interaction_spec_archived/*`: Iterative interaction spec loop referenced only in unreachable code blocks within `main.py`.
- `src/app_factory_leonardo_replit/stages/stage_2_wireframe_archived.py` and the entire `agents/stage_2_wireframe_archived/*` suite (critic/QC/integration analyzer/retrospective): Legacy Next.js wireframe pipeline bypassed by the newer build stage.
- `src/app_factory_leonardo_replit/initialization/frontend_archived/*`: Next.js template initializer used solely by Stage 2 wireframe.
- `src/app_factory_leonardo_replit/stages/build_stage_old_archived.py`: Obsolete build implementation, no import references.
- `src/app_factory_leonardo_replit/agents/component_analyzer_archived/*`: Analyzer never invoked by the active build flow.
- Documentation tied to the unused stages (e.g., `stages/docs/stage_2_implementation_archived.md`).

The `_archived` suffix keeps the history nearby while preventing accidental imports in the active pipeline.
