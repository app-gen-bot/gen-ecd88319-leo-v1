name: Publish to CodeArtifact

on:
  push:
    tags:
      - 'v*'           # Standard version tags (v1.0.0, v2.1.3, etc.)
      - '*-v*'         # Branch version tags (feature-v1.0.0, etc.)

permissions:
  id-token: write    # Required for OIDC authentication
  contents: read     # Required to read repository

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_CODEARTIFACT_ROLE_ARN }}
          role-session-name: GitHubCodeArtifactPublisher
          aws-region: us-east-1
      
      - name: Get AWS Account ID and CodeArtifact Token
        id: aws-config
        run: |
          # Dynamically resolve AWS account ID - no hardcoding!
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          # Get CodeArtifact domain and repository from environment or use defaults
          DOMAIN="${CODEARTIFACT_DOMAIN:-cc-internal}"
          REPOSITORY="${CODEARTIFACT_REPOSITORY:-python-internal}"
          REGION="${AWS_REGION:-us-east-1}"
          
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT
          
          # Get CodeArtifact authorization token
          TOKEN=$(aws codeartifact get-authorization-token \
            --domain $DOMAIN \
            --domain-owner $ACCOUNT_ID \
            --query authorizationToken \
            --output text)
          
          # Mask the token in logs
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          
          # Build repository URL
          REPO_URL="https://${DOMAIN}-${ACCOUNT_ID}.d.codeartifact.${REGION}.amazonaws.com/pypi/${REPOSITORY}/"
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          
          echo "✅ CodeArtifact configuration complete"
          echo "   Domain: $DOMAIN"
          echo "   Repository: $REPOSITORY"
          echo "   Account: $ACCOUNT_ID"
          echo "   Region: $REGION"
      
      - name: Install dependencies
        run: |
          uv pip install --system build twine
      
      - name: Build package
        run: |
          echo "Building cc-tools package..."
          uv build
          
          # List built artifacts
          echo "Built artifacts:"
          ls -la dist/
      
      - name: Publish to CodeArtifact
        env:
          UV_PUBLISH_USERNAME: aws
          UV_PUBLISH_PASSWORD: ${{ steps.aws-config.outputs.token }}
          UV_PUBLISH_URL: ${{ steps.aws-config.outputs.repo_url }}
        run: |
          echo "Publishing to CodeArtifact..."
          echo "Repository URL: $UV_PUBLISH_URL"
          
          # Publish using uv
          uv publish \
            --publish-url "$UV_PUBLISH_URL" \
            --username aws \
            --password "$UV_PUBLISH_PASSWORD"
          
          echo "✅ Successfully published cc-tools to CodeArtifact"
      
      - name: Verify publication
        run: |
          # Get package name from pyproject.toml
          PACKAGE_NAME=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])")
          
          # List package versions in CodeArtifact
          echo "Verifying package in CodeArtifact..."
          aws codeartifact list-package-versions \
            --domain ${{ steps.aws-config.outputs.domain }} \
            --domain-owner ${{ steps.aws-config.outputs.account_id }} \
            --repository ${{ steps.aws-config.outputs.repository }} \
            --package $PACKAGE_NAME \
            --format pypi \
            --output table