# Leo Remote Container Issues - 2025-12-11

## Summary

Generation is working end-to-end but several issues need to be addressed.

**Last successful run:**
- App: todo-app
- Container: `leo-container:12f988f3`
- S3: `s3://leo-saas-generated-apps-855235011337/generations/req_mj26dnut_uvxh7t/app.tar.gz`
- Cost: ~$1.28 total ($1.12 + $0.16)

---

## Issues to Fix

### P0: Git commit fails (exit status 128)

**Error:**
```
ERROR Failed to create commit: Command '['git', 'commit', '-m', '...']' returned non-zero exit status 128.
```

**Cause:** Git user.name/user.email not configured in container.

**Fix:** Add to Dockerfile:
```dockerfile
RUN git config --global user.name "Leo Generator" && \
    git config --global user.email "leo@example.com"
```

**Location:** `/Users/jake/dev/app-factory/Dockerfile`

---

### P1: Supabase CLI not installed

**Error:**
```
INFO  AppGeneratorAgent: Since the Supabase CLI is not installed and we cannot set up a real Supabase project...
```

**Impact:** Agent falls back to mock environment setup instead of creating real Supabase project.

**Fix Options:**
1. Install Supabase CLI in Dockerfile: `npm install -g supabase`
2. Or ensure MCP server for Supabase is properly configured

**Location:** `/Users/jake/dev/app-factory/Dockerfile` or MCP config

---

### P2: Iteration loop not working (stops at 1)

**Observed:**
```
Reason: max_iterations
Iterations: 1
```

**Expected:** Should continue refinement loop up to max_iterations (10)

**Analysis:** The agent completed generation in one turn but the iteration loop thinks it hit max. The WSI client or orchestration logic may be counting wrong.

**Location:**
- `/Users/jake/dev/app-factory/remote/container/leo_container/wsi_client/client.py`
- Or CLI orchestration logic

---

### P3: Double S3 upload

**Observed:** S3 upload happens twice:
```
INFO  Uploading to S3...
INFO  Upload complete: s3://...

[later]

INFO  Autonomous mode - uploading to S3 and detecting artifacts
INFO  Creating archive: /tmp/tmplvfe7w92/app.tar.gz
INFO  Uploading to s3://...
```

**Impact:** Wasted time/bandwidth, potential race conditions

**Location:** WSI client cleanup/completion logic

---

### P4: Double "Creating new app" log

**Observed:**
```
INFO  Creating new app: todo-app
INFO  Creating new app: todo-app
```

**Impact:** Minor, just noise

**Location:** Agent startup code

---

## Files Modified Recently

- `Dockerfile` - Added Chromium, fixed skills path
- `remote/container/leo_container/managers/s3_manager.py` - Hardcoded default bucket
- `remote/container/leo_container/wsi_client/client.py` - Enhanced error handling
- `remote/container/requirements.txt` - Added psutil

## Recent Commits

- `53a1e861` - fix: Copy skills to /workspace/app/.claude/skills/
- `12f988f3` - feat: Add enhanced error handling for generation failures
- `2818c3f1` - feat: Add Chromium, fix skills path, hardcode S3 bucket

---

## What's Working

- Skills are now found correctly (path fix worked)
- S3 upload with hardcoded bucket works
- Chrome/Chromium installed for browser automation
- Error handling captures more details
- End-to-end generation completes

---

## Resume Instructions

1. Read this file
2. Fix P0 (git config) first - quick win
3. Then P1 (Supabase CLI)
4. Investigate P2 (iteration loop) - may need deeper analysis
5. Rebuild container and test
