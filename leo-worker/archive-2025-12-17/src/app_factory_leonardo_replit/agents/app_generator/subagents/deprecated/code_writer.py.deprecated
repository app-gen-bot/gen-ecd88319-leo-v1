"""
DEPRECATED: This subagent has been converted to a skill.

Migration Date: 2025-11-18
Skill Location: ~/.claude/skills/code-writer/SKILL.md
Source Control: ~/apps/app-factory/apps/.claude/skills/code-writer/SKILL.md
Reason: Skills provide full context awareness for resume/modification workflows.
        After deep analysis, 61% of pattern content was bloat (2,572 of 4,212 lines).
        Core 8 P0 patterns now condensed to 535-line skill.

DO NOT USE THIS SUBAGENT.
Main agent should invoke the code-writer skill instead.

See: docs/CODE_WRITER_DEEP_ANALYSIS.md
See: docs/SUBAGENT_TO_SKILL_MIGRATION_PLAYBOOK.md

Pattern files preserved in: docs/patterns/code_writer/ (backup)

---

Original Description:
CodeWriter - Specialized agent for writing production code.

This agent writes clean, typed TypeScript and React code following
best practices and project conventions.
"""

import os
from pathlib import Path
from .research_agent import AgentDefinition

# Get APP_FACTORY_ROOT from environment, with auto-detection fallback
def get_app_factory_root() -> Path:
    """
    Get the app factory root directory.

    Tries environment variable first, then auto-detects from code location.
    Validates the path exists and contains expected structure.
    """
    # Try environment variable first
    env_root = os.getenv('APP_FACTORY_ROOT')
    if env_root:
        root = Path(env_root)
        if root.exists():
            return root
        else:
            print(f"Warning: APP_FACTORY_ROOT env var set to '{env_root}' but path doesn't exist. Auto-detecting...")

    # Auto-detect from code location (go up 5 levels from this file)
    # code_writer.py -> subagents -> app_generator -> agents -> agents -> src -> project_root
    detected_root = Path(__file__).resolve().parents[5]

    # Validate structure (check for docs/patterns directory)
    patterns_dir = detected_root / "docs" / "patterns"
    if patterns_dir.exists():
        return detected_root
    else:
        raise RuntimeError(
            f"Could not find app factory root. Tried:\n"
            f"  - Environment variable APP_FACTORY_ROOT: {env_root or 'not set'}\n"
            f"  - Auto-detected path: {detected_root}\n"
            f"  - Expected to find: {patterns_dir}\n"
            f"Please set APP_FACTORY_ROOT environment variable to the project root."
        )

# Get root directory
APP_FACTORY_ROOT = get_app_factory_root()

# Construct pattern file paths
PATTERNS_DIR = APP_FACTORY_ROOT / "docs" / "patterns" / "code_writer"

# Validate patterns directory exists
if not PATTERNS_DIR.exists():
    raise RuntimeError(
        f"Code writer patterns directory not found: {PATTERNS_DIR}\n"
        f"APP_FACTORY_ROOT: {APP_FACTORY_ROOT}\n"
        f"Please ensure pattern files are in the correct location."
    )

# Pattern file paths (validated at module load time)
PATTERN_FILES = {
    "core_identity": PATTERNS_DIR / "CORE_IDENTITY.md",
    "storage_completeness": PATTERNS_DIR / "STORAGE_COMPLETENESS.md",
    "interactive_state": PATTERNS_DIR / "INTERACTIVE_STATE.md",
    "auth_helpers": PATTERNS_DIR / "AUTH_HELPERS.md",
    "esm_imports": PATTERNS_DIR / "ESM_IMPORTS.md",
    "wouter_routing": PATTERNS_DIR / "WOUTER_ROUTING.md",
    "wouter_link": PATTERNS_DIR / "WOUTER_LINK.md",
    "date_calculations": PATTERNS_DIR / "DATE_CALCULATIONS.md",
    "id_flexibility": PATTERNS_DIR / "ID_FLEXIBILITY.md",
    "ts_rest_v3": PATTERNS_DIR / "TS_REST_V3_API.md",
    "react_query": PATTERNS_DIR / "REACT_QUERY_PROVIDER.md",
    "proxy_binding": PATTERNS_DIR / "PROXY_METHOD_BINDING.md",
    "shadcn_exports": PATTERNS_DIR / "SHADCN_EXPORTS.md",
    "code_patterns": PATTERNS_DIR / "CODE_PATTERNS.md",
    "validation": PATTERNS_DIR / "VALIDATION_CHECKLIST.md",
}

# Validate all pattern files exist
missing_files = [name for name, path in PATTERN_FILES.items() if not path.exists()]
if missing_files:
    raise RuntimeError(
        f"Missing code_writer pattern files: {', '.join(missing_files)}\n"
        f"Expected location: {PATTERNS_DIR}\n"
        f"Please ensure all pattern files are present."
    )

code_writer = AgentDefinition(
    description="Write production-ready TypeScript/React code",
    prompt=f"""You MUST complete the code implementation task. You are a senior full-stack developer writing production-ready code.

## CRITICAL PATTERNS - READ BEFORE WRITING CODE

BEFORE writing ANY code, you MUST READ these pattern files to understand critical requirements:

### Core Patterns (MANDATORY - Read ALL before starting)
1. **Core Identity & Workflow**: {PATTERN_FILES['core_identity']}
2. **Storage Method Completeness**: {PATTERN_FILES['storage_completeness']}
3. **Interactive Component State**: {PATTERN_FILES['interactive_state']}
4. **Auth Helpers Centralization**: {PATTERN_FILES['auth_helpers']}
5. **ESM Import Extensions**: {PATTERN_FILES['esm_imports']}
6. **Wouter Routing Props**: {PATTERN_FILES['wouter_routing']}
7. **Wouter Link Usage**: {PATTERN_FILES['wouter_link']}
8. **Date Calculation Edge Cases**: {PATTERN_FILES['date_calculations']}
9. **ID Type Flexibility**: {PATTERN_FILES['id_flexibility']}

### Recent Critical Fixes (MUST READ for recent issues)
10. **ts-rest v3 API Client**: {PATTERN_FILES['ts_rest_v3']}
11. **React Query Provider**: {PATTERN_FILES['react_query']}
12. **Proxy Method Binding**: {PATTERN_FILES['proxy_binding']}
13. **ShadCN Component Exports**: {PATTERN_FILES['shadcn_exports']}

### Validation & Reference
- **Code Patterns Reference**: {PATTERN_FILES['code_patterns']}
- **Pre-Completion Validation**: {PATTERN_FILES['validation']}

**YOU MUST READ ALL 13 CORE PATTERNS BEFORE WRITING CODE.** These patterns prevent critical production failures documented in EdVisor Issues #3, #5, #6, #7, #11, #12, #16, #17, #18, #22, #23 and asana-clone production bugs.

---

## BEFORE Writing Code - MANDATORY CHECKLIST

1. **Read schemas first**: Read schema.zod.ts to understand ALL data types
2. **Import types correctly**: NEVER redefine types - import from shared files
3. **Use exact field names**: Schema field names are contracts - match exactly
4. **Plan implementation**: Understand complete flow before writing
5. **Check for backend data**: If component displays data → MUST use useQuery + apiClient (NO placeholders)
6. **Read ALL 13 patterns above**: Understand requirements for your specific task

---

## Your Responsibilities (High-Level)

### 1. Code Quality
- Write clean, typed TypeScript (no 'any' types)
- Follow ESLint/Prettier conventions
- Include JSDoc for complex functions
- Handle errors gracefully

### 2. React Best Practices
- Functional components with hooks
- Proper state management
- Loading states with skeletons
- Error boundaries where appropriate
- Optimize re-renders (memo/callback)

### 3. Backend Implementation
- Async/await for all async operations
- Try/catch error handling
- Zod schema validation (import from schema.zod.ts, NEVER redefine)
- Storage factory pattern
- Appropriate HTTP status codes

### 4. Frontend Implementation
- apiClient for ALL API calls (no fetch)
- NO mock/placeholder data - use real APIs
- Loading states for all async operations
- User-friendly error messages
- Proper form validation

### 5. Testing & Validation
- Run validation checks from VALIDATION_CHECKLIST.md
- Use mcp__build_test__verify_project for builds
- Use mcp__oxc for linting
- Fix ALL errors before marking complete

---

## CRITICAL REQUIREMENTS (DO NOT SKIP)

**MUST DO**:
- READ ALL 13 PATTERN FILES listed above before writing code
- Import types from shared files (schema.zod.ts, contracts)
- Use storage factory pattern (never direct database calls)
- Add loading states for all async operations
- Validate ALL code with VALIDATION_CHECKLIST.md before completion
- Run linting and type checking before marking complete

**NEVER DO**:
- Redefine types that exist in schemas
- Use placeholder/mock data in components that should show real data
- Skip reading pattern files (they prevent production failures)
- Commit code with linting errors
- Skip validation checklist

---

## Workflow

1. **Read Task** → Understand requirements
2. **Read Patterns** → Read ALL 13 pattern files relevant to task
3. **Read Schemas** → Understand data structures
4. **Plan** → Design solution following patterns
5. **Implement** → Write code applying all patterns
6. **Validate** → Run VALIDATION_CHECKLIST.md checks
7. **Test** → Verify builds and lints pass
8. **Complete** → Mark task done only if ALL validations pass

---

## Remember

These patterns exist because they prevent REAL production failures:
- **EdVisor Issues**: #3, #5, #6, #7, #11, #12, #16, #17, #18, #22, #23
- **asana-clone bugs**: 404 errors, crashes, auth failures, component exports
- **Time saved**: ~11+ hours per app by following these patterns

**If validation fails, FIX immediately. Do NOT mark complete with failing checks.**

APPLY ALL 13 PATTERNS from the files listed above.
""",
    tools=["Read", "Write", "Edit", "TodoWrite", "Bash", "mcp__build_test__verify_project", "mcp__oxc", "mcp__supabase"],
    model="sonnet"
)
