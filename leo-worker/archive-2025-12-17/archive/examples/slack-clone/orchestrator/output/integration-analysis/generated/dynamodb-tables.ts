/**
 * DynamoDB Table Definitions for Slack Clone Application
 * 
 * These table definitions are generated based on the data structures
 * found in the frontend wireframe and optimized for the access patterns
 * identified in the integration analysis.
 * 
 * Generated by: Integration Analyzer Tool
 * Date: 2025-06-29
 */

import { DynamoDB } from 'aws-sdk';

export type TableDefinition = DynamoDB.CreateTableInput;

/**
 * Table naming convention: slack-clone-{environment}-{table}
 * Environment will be injected at runtime (dev, staging, prod)
 */
const getTableName = (baseName: string, environment = 'dev') => 
  `slack-clone-${environment}-${baseName}`;

export const tableDefinitions = {
  /**
   * Users Table
   * Primary Key: id (user ID)
   * GSI: email-index for login lookup
   */
  Users: (environment?: string): TableDefinition => ({
    TableName: getTableName('users', environment),
    AttributeDefinitions: [
      { AttributeName: 'id', AttributeType: 'S' },
      { AttributeName: 'email', AttributeType: 'S' },
      { AttributeName: 'workspaceId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'id', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'email-index',
        KeySchema: [
          { AttributeName: 'email', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      },
      {
        IndexName: 'workspace-index',
        KeySchema: [
          { AttributeName: 'workspaceId', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    },
    StreamSpecification: {
      StreamViewType: 'NEW_AND_OLD_IMAGES'
    }
  }),

  /**
   * Workspaces Table
   * Primary Key: id (workspace ID)
   */
  Workspaces: (environment?: string): TableDefinition => ({
    TableName: getTableName('workspaces', environment),
    AttributeDefinitions: [
      { AttributeName: 'id', AttributeType: 'S' },
      { AttributeName: 'ownerId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'id', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'owner-index',
        KeySchema: [
          { AttributeName: 'ownerId', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 5,
      WriteCapacityUnits: 5
    }
  }),

  /**
   * Channels Table
   * Primary Key: id (channel ID)
   * GSI: workspace-index for listing channels by workspace
   */
  Channels: (environment?: string): TableDefinition => ({
    TableName: getTableName('channels', environment),
    AttributeDefinitions: [
      { AttributeName: 'id', AttributeType: 'S' },
      { AttributeName: 'workspaceId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'id', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'workspace-index',
        KeySchema: [
          { AttributeName: 'workspaceId', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 10,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    }
  }),

  /**
   * Channel Memberships Table
   * Primary Key: channelId + userId (composite key)
   * GSI: user-index for finding all channels a user belongs to
   */
  ChannelMemberships: (environment?: string): TableDefinition => ({
    TableName: getTableName('channel-memberships', environment),
    AttributeDefinitions: [
      { AttributeName: 'channelId', AttributeType: 'S' },
      { AttributeName: 'userId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'channelId', KeyType: 'HASH' },
      { AttributeName: 'userId', KeyType: 'RANGE' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'user-index',
        KeySchema: [
          { AttributeName: 'userId', KeyType: 'HASH' },
          { AttributeName: 'channelId', KeyType: 'RANGE' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 10,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    }
  }),

  /**
   * Messages Table
   * Primary Key: channelId + timestamp (for channel messages)
   * GSI: user-messages-index for finding messages by user
   * Note: Direct messages use conversationId instead of channelId
   */
  Messages: (environment?: string): TableDefinition => ({
    TableName: getTableName('messages', environment),
    AttributeDefinitions: [
      { AttributeName: 'channelId', AttributeType: 'S' },
      { AttributeName: 'timestamp', AttributeType: 'S' },
      { AttributeName: 'userId', AttributeType: 'S' },
      { AttributeName: 'id', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'channelId', KeyType: 'HASH' },
      { AttributeName: 'timestamp', KeyType: 'RANGE' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'user-messages-index',
        KeySchema: [
          { AttributeName: 'userId', KeyType: 'HASH' },
          { AttributeName: 'timestamp', KeyType: 'RANGE' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      },
      {
        IndexName: 'message-id-index',
        KeySchema: [
          { AttributeName: 'id', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 20,
      WriteCapacityUnits: 20
    },
    StreamSpecification: {
      StreamViewType: 'NEW_AND_OLD_IMAGES'
    }
  }),

  /**
   * Conversations Table (for Direct Messages)
   * Primary Key: id (conversation ID)
   * GSI: participant-index for finding conversations by user
   */
  Conversations: (environment?: string): TableDefinition => ({
    TableName: getTableName('conversations', environment),
    AttributeDefinitions: [
      { AttributeName: 'id', AttributeType: 'S' },
      { AttributeName: 'workspaceId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'id', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'workspace-index',
        KeySchema: [
          { AttributeName: 'workspaceId', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    }
  }),

  /**
   * Conversation Participants Table
   * Primary Key: conversationId + userId
   * GSI: user-conversations-index for finding all conversations for a user
   */
  ConversationParticipants: (environment?: string): TableDefinition => ({
    TableName: getTableName('conversation-participants', environment),
    AttributeDefinitions: [
      { AttributeName: 'conversationId', AttributeType: 'S' },
      { AttributeName: 'userId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'conversationId', KeyType: 'HASH' },
      { AttributeName: 'userId', KeyType: 'RANGE' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'user-conversations-index',
        KeySchema: [
          { AttributeName: 'userId', KeyType: 'HASH' },
          { AttributeName: 'conversationId', KeyType: 'RANGE' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 10,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    }
  }),

  /**
   * Notifications Table
   * Primary Key: userId + timestamp
   * Allows efficient querying of notifications for a user
   */
  Notifications: (environment?: string): TableDefinition => ({
    TableName: getTableName('notifications', environment),
    AttributeDefinitions: [
      { AttributeName: 'userId', AttributeType: 'S' },
      { AttributeName: 'timestamp', AttributeType: 'S' },
      { AttributeName: 'id', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'userId', KeyType: 'HASH' },
      { AttributeName: 'timestamp', KeyType: 'RANGE' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'notification-id-index',
        KeySchema: [
          { AttributeName: 'id', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 10,
      WriteCapacityUnits: 10
    },
    StreamSpecification: {
      StreamViewType: 'NEW_IMAGE'
    }
  }),

  /**
   * Files Table
   * Primary Key: id (file ID)
   * GSI: channel-files-index for listing files in a channel
   * GSI: user-files-index for listing files uploaded by a user
   */
  Files: (environment?: string): TableDefinition => ({
    TableName: getTableName('files', environment),
    AttributeDefinitions: [
      { AttributeName: 'id', AttributeType: 'S' },
      { AttributeName: 'channelId', AttributeType: 'S' },
      { AttributeName: 'uploadedBy', AttributeType: 'S' },
      { AttributeName: 'uploadedAt', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'id', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'channel-files-index',
        KeySchema: [
          { AttributeName: 'channelId', KeyType: 'HASH' },
          { AttributeName: 'uploadedAt', KeyType: 'RANGE' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      },
      {
        IndexName: 'user-files-index',
        KeySchema: [
          { AttributeName: 'uploadedBy', KeyType: 'HASH' },
          { AttributeName: 'uploadedAt', KeyType: 'RANGE' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 5,
      WriteCapacityUnits: 5
    }
  }),

  /**
   * Presence Table
   * Primary Key: userId
   * For real-time user status tracking
   * Consider using TTL for automatic cleanup of stale records
   */
  Presence: (environment?: string): TableDefinition => ({
    TableName: getTableName('presence', environment),
    AttributeDefinitions: [
      { AttributeName: 'userId', AttributeType: 'S' },
      { AttributeName: 'workspaceId', AttributeType: 'S' }
    ],
    KeySchema: [
      { AttributeName: 'userId', KeyType: 'HASH' }
    ],
    GlobalSecondaryIndexes: [
      {
        IndexName: 'workspace-presence-index',
        KeySchema: [
          { AttributeName: 'workspaceId', KeyType: 'HASH' }
        ],
        Projection: { ProjectionType: 'ALL' },
        ProvisionedThroughput: {
          ReadCapacityUnits: 10,
          WriteCapacityUnits: 10
        }
      }
    ],
    ProvisionedThroughput: {
      ReadCapacityUnits: 20,
      WriteCapacityUnits: 20
    },
    StreamSpecification: {
      StreamViewType: 'NEW_AND_OLD_IMAGES'
    }
  })
};

/**
 * Helper function to create all tables
 */
export function getAllTableDefinitions(environment = 'dev'): TableDefinition[] {
  return Object.values(tableDefinitions).map(definition => definition(environment));
}

/**
 * Table creation order considering dependencies
 * 1. Independent tables first (Workspaces, Users)
 * 2. Dependent tables next (Channels, Conversations)
 * 3. Junction tables (ChannelMemberships, ConversationParticipants)
 * 4. Content tables (Messages, Files, Notifications)
 * 5. Real-time tables (Presence)
 */
export const tableCreationOrder = [
  'Workspaces',
  'Users',
  'Channels',
  'Conversations',
  'ChannelMemberships',
  'ConversationParticipants',
  'Messages',
  'Files',
  'Notifications',
  'Presence'
];

/**
 * DynamoDB best practices implemented:
 * 1. Composite keys for 1-to-many relationships
 * 2. GSIs for alternate access patterns
 * 3. Streams for real-time features
 * 4. Appropriate provisioned throughput based on expected load
 * 5. Projection types optimized for query patterns
 */