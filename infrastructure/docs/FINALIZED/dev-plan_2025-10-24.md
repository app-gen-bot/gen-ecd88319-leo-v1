# Development Plan: App-Gen SaaS Infrastructure
**Date:** October 24, 2025
**Repository:** app-gen-infra
**Related Repos:** app-gen-saas (Application), app-gen (Generator Agent)

---

## Executive Summary

This repository (`app-gen-infra`) provides AWS CDK infrastructure-as-code for deploying the App-Gen SaaS platform. The system consists of three repositories working together:

1. **app-gen-infra** (This repo) - AWS CDK infrastructure definitions
2. **app-gen-saas** - TypeScript web application (orchestrator)
3. **app-gen** - Python AI agent (generator)

**Current State:** Infrastructure is COMPLETE and DEPLOYED. This is a maintenance/documentation task, NOT an implementation task.

**Architecture Pattern:** ECS Fargate + ALB + ACM (Mandatory - see docs/deployment.md)

---

## 1. Discovery and Assessment Phase

### 1.1 System Understanding

**Purpose:**
SaaS platform that generates React/Vite/Express web applications using AI (Claude Code). Users submit app requirements through a web interface, the system generates the application, and delivers it via S3 download, GitHub repository creation, or automatic deployment to Fly.io.

**Three-Repository Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Browser                               â”‚
â”‚  (React UI served from orchestrator)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ HTTPS
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Load Balancer                  â”‚
â”‚  - SSL/TLS Termination (ACM Certificate)    â”‚
â”‚  - Routes to orchestrator on port 5013      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ HTTP (internal)
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Orchestrator Container (app-gen-saas)      â”‚
â”‚  - ECS Fargate Service (always running)     â”‚
â”‚  - Serves React UI + Express API            â”‚
â”‚  - Manages WebSocket connections            â”‚
â”‚  - Spawns generator tasks via ECS RunTask   â”‚
â”‚  - 2GB RAM, 1 vCPU                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Spawns via ECS API
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generator Container (app-gen)              â”‚
â”‚  - ECS Fargate Task (ephemeral)             â”‚
â”‚  - Generates apps using Claude Code         â”‚
â”‚  - Uploads to S3, GitHub, Fly.io            â”‚
â”‚  - Auto-terminates when complete            â”‚
â”‚  - 8GB RAM, 4 vCPU                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3 Bucket                   â”‚  GitHub      â”‚
â”‚  (Generated apps, 30-day     â”‚  (Repo       â”‚
â”‚   lifecycle deletion)        â”‚   creation)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Pattern:**
- Orchestrator: Persistent (1 task always running)
- Generator: Ephemeral (spawned per job, terminates on completion)
- Multiple generators can run concurrently for parallel job processing

**Infrastructure Components:**

| Component | AWS Service | Configuration | Status |
|-----------|-------------|---------------|--------|
| **Compute** | ECS Fargate | Orchestrator: 1 task (2GB/1vCPU)<br>Generator: On-demand (8GB/4vCPU) | âœ… DEPLOYED |
| **Networking** | VPC + ALB | 2 AZs, public subnets, security groups | âœ… DEPLOYED |
| **Container Registry** | ECR | 2 repos: app-gen-saas-app, app-gen-saas-generator | âœ… DEPLOYED |
| **Storage** | S3 | Generated apps with 30-day lifecycle | âœ… DEPLOYED |
| **Secrets** | Secrets Manager | Supabase auth/DB, Claude OAuth, GitHub token | âœ… DEPLOYED |
| **Observability** | CloudWatch Logs | 1-week retention per service | âœ… DEPLOYED |

---

### 1.2 Current State Assessment

#### Infrastructure Code Status (app-gen-infra)

**Files Inventory:**
```
app-gen-infra/
â”œâ”€â”€ lib/fargate-poc-stack.ts         âœ… COMPLETE (417 lines)
â”œâ”€â”€ bin/fargate-poc.ts               âœ… COMPLETE (CDK entry point)
â”œâ”€â”€ cdk.json                         âœ… COMPLETE (CDK config)
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ system-overview.md           âœ… COMPLETE (Authoritative reference)
â”‚   â”œâ”€â”€ architecture.md              âœ… COMPLETE (1034 lines, canonical)
â”‚   â”œâ”€â”€ deployment.md                âœ… COMPLETE (680 lines, mandatory pattern)
â”‚   â”œâ”€â”€ environment-configuration.md âœ… COMPLETE
â”‚   â”œâ”€â”€ mvp-steps.md                 âœ… COMPLETE
â”‚   â”œâ”€â”€ scale-steps.md               âœ… COMPLETE
â”‚   â””â”€â”€ secrets-management.md        âœ… COMPLETE
â”œâ”€â”€ QUICK_START_DEV_SETUP.md         âœ… COMPLETE (EC2 build optimization)
â””â”€â”€ README.md                        âœ… COMPLETE
```

**Infrastructure Features Implemented:**

| Feature | Required | Implemented | Status |
|---------|----------|-------------|--------|
| VPC with 2 AZs | âœ… | âœ… | Lines 17-29 in stack |
| ALB with HTTPS | âœ… | âœ… | Lines 271-350 |
| ACM Certificate Support | âœ… | âœ… | Context-based (line 313) |
| ECR Repositories (2) | âœ… | âœ… | Lines 90-100 |
| Orchestrator Task Definition | âœ… | âœ… | Lines 165-201 |
| Generator Task Definition | âœ… | âœ… | Lines 203-224 |
| Orchestrator Service | âœ… | âœ… | Lines 280-290 |
| S3 Bucket (30-day lifecycle) | âœ… | âœ… | Lines 61-76 |
| Secrets Manager Integration | âœ… | âœ… | Lines 31-82, 178-184 |
| Security Groups | âœ… | âœ… | Lines 231-269 |
| IAM Task Roles | âœ… | âœ… | Lines 102-163 |
| CloudWatch Logs | âœ… | âœ… | Lines 174-176, 213-215 |
| IPv6 Support | âœ… | âœ… | Line 20 |
| Health Check Configuration | âœ… | âœ… | Lines 297-303 |

**All infrastructure features are COMPLETE.**

---

#### Application Code Status (app-gen-saas)

**Schema Status:**

```typescript
// shared/schema.zod.ts - âœ… COMPLETE
- users schema (with Supabase Auth integration)
- generationRequests schema
- All insert/update schemas defined
- Full type exports

// shared/schema.ts - âœ… COMPLETE
- Drizzle ORM schema for generation_requests table
- Note: No users table (Supabase Auth handles user management)
```

**Backend Routes Implemented:**

| Endpoint | Method | Auth | Implemented | Location |
|----------|--------|------|-------------|----------|
| POST /api/generations | POST | âœ… | âœ… | server/routes/generations.ts:14 |
| GET /api/generations | GET | âœ… | âœ… | server/routes/generations.ts:56 |
| GET /api/generations/:id | GET | âœ… | âœ… | server/routes/generations.ts:80 |
| GET /api/generations/:id/logs | GET | âœ… | âœ… | server/routes/generations.ts:107 |
| GET /api/generations/:id/download | GET | âœ… | âœ… | server/routes/generations.ts:176 |
| POST /api/generations/:id/complete-test | POST | âœ… | âœ… | server/routes/generations.ts:141 |
| GET /health | GET | - | âœ… | server/index.ts:54 |

**Frontend Pages Implemented:**

| Page | Path | Auth Required | Implemented | Location |
|------|------|---------------|-------------|----------|
| Home | / | - | âœ… | client/src/pages/HomePage.tsx |
| Login | /login | - | âœ… | client/src/pages/LoginPage.tsx |
| Register | /register | - | âœ… | client/src/pages/RegisterPage.tsx |
| Dashboard | /dashboard | âœ… | âœ… | client/src/pages/DashboardPage.tsx |

**Backend Services Implemented:**

| Service | Pattern | Implemented | Location |
|---------|---------|-------------|----------|
| Auth | Factory (mock/supabase) | âœ… | server/lib/auth/ |
| Storage | Factory (memory/database) | âœ… | server/lib/storage/ |
| Orchestrator | Factory (local/AWS) | âœ… | server/lib/orchestrator/ |
| WebSocket | Real-time updates | âœ… | server/lib/websocket-server.ts |
| GitHub Manager | Repo creation | âœ… | server/lib/github-manager.ts |

**All application features are COMPLETE.**

---

### 1.3 Gap Analysis

**Result:** NO GAPS FOUND

The system is **FULLY IMPLEMENTED AND DEPLOYED**. This is an infrastructure repository with complete CDK definitions, comprehensive documentation, and all supporting application code in sibling repositories.

**Comparison Table:**

| Feature | System Overview Requires | Current Implementation | Status |
|---------|-------------------------|------------------------|--------|
| Orchestrator Container | ECS Fargate Service | âœ… Deployed (2GB/1vCPU) | âœ… COMPLETE |
| Generator Container | ECS Fargate Task Def | âœ… Deployed (8GB/4vCPU) | âœ… COMPLETE |
| Task Spawning | ECS RunTask API | âœ… Implemented (aws-orchestrator.ts) | âœ… COMPLETE |
| WebSocket Streaming | Real-time logs | âœ… Implemented (websocket-server.ts) | âœ… COMPLETE |
| S3 Storage | Generated apps | âœ… Deployed (30-day lifecycle) | âœ… COMPLETE |
| GitHub Integration | Repo creation | âœ… Implemented (github-manager.ts) | âœ… COMPLETE |
| Fly.io Deployment | Auto-deploy | âœ… Implemented (fly-toml.ts) | âœ… COMPLETE |
| Supabase Auth | User management | âœ… Implemented (supabase-adapter.ts) | âœ… COMPLETE |
| Database | PostgreSQL | âœ… Supabase (connection pooling) | âœ… COMPLETE |
| Secrets Management | AWS Secrets Manager | âœ… Deployed (7 secrets) | âœ… COMPLETE |
| HTTPS/SSL | ALB + ACM | âœ… Deployed (optional cert via context) | âœ… COMPLETE |
| Monitoring | CloudWatch Logs | âœ… Deployed (1-week retention) | âœ… COMPLETE |

**Conclusion:** This is a documentation and maintenance task, NOT a development task.

---

## 2. Implementation Plan

### 2.1 Status: NO IMPLEMENTATION REQUIRED

All features from the system overview are fully implemented and deployed. The infrastructure stack is live and operational.

**What IS needed:**
1. âœ… Documentation review (this plan)
2. âœ… Testing methodology documentation (see Section 3)
3. âœ… Maintenance procedures (see Section 4)
4. âœ… Troubleshooting guides (already in docs/)

**What is NOT needed:**
- âŒ No schema changes required
- âŒ No new backend endpoints required
- âŒ No new frontend pages required
- âŒ No infrastructure changes required

---

### 2.2 Recommended Next Steps (Optional Enhancements)

If future development is required, prioritize in this order:

#### Phase 1: Scale Triggers (When Needed)
**Implement when ANY of these conditions are met:**
- > 100 concurrent users
- > 500 WebSocket connections
- Multi-region users requiring CDN

**Changes Required:**
1. Separate frontend to CloudFront + S3
2. Scale orchestrator service (1 â†’ 10 tasks)
3. Implement ECS auto-scaling based on metrics
4. See `docs/scale-steps.md` for migration guide

#### Phase 2: Cost Optimization (Optional)
**Potential savings: ~30% (~$6/month)**

1. **Fargate Spot for generator tasks** (70% discount on generator costs)
   - Update `appGeneratorTaskDef` with `capacityProviderStrategy`
   - Risk: Occasional task interruption (acceptable for generation workload)

2. **S3 Intelligent-Tiering** (auto-archive rarely accessed apps)
   - Already using lifecycle deletion (30 days)
   - Could add Intelligent-Tiering for cost optimization

3. **CloudWatch log filtering** (reduce ingestion costs)
   - Currently logging everything
   - Could filter DEBUG logs in production

#### Phase 3: Enhanced Observability (Nice-to-have)
1. CloudWatch alarms for ECS task failures
2. X-Ray tracing for generation request flow
3. CloudWatch dashboards for key metrics
4. SNS notifications for deployment events

---

## 3. Testing Methodology

### 3.1 Philosophy

**Critical Principle:** This is an INFRASTRUCTURE repository. Testing focuses on deployment verification, not application logic.

**Application testing** (schemas, routes, UI) happens in the **app-gen-saas** repository using:
- Backend: curl commands
- Frontend: browser MCP tools
- Integration: End-to-end user flows

**Infrastructure testing** (this repo) focuses on:
- CDK synthesis and deployment
- AWS resource creation and configuration
- Network connectivity and security
- Container deployment and health

---

### 3.2 Infrastructure Testing (This Repo)

#### 3.2.1 CDK Synthesis Test

**Purpose:** Verify CDK code compiles and generates valid CloudFormation

```bash
cd /home/ec2-user/APP_GEN/app-gen-infra

# Test 1: TypeScript compilation
npm run build

# Expected: No compilation errors
# Location: lib/fargate-poc-stack.d.ts should be created

# Test 2: CDK synthesis
npx cdk synth

# Expected: Generates CloudFormation template (cdk.out/)
# Verify key resources exist in template:
# - AWS::EC2::VPC
# - AWS::ElasticLoadBalancingV2::LoadBalancer
# - AWS::ECS::Cluster
# - AWS::ECS::Service
# - AWS::ECS::TaskDefinition (x2)
# - AWS::ECR::Repository (x2)
# - AWS::S3::Bucket
```

#### 3.2.2 Deployment Verification Test

**Purpose:** Verify infrastructure deploys successfully

```bash
# Test 1: Preview changes
npx cdk diff

# Expected: Shows diff between deployed and current code
# If no changes: "There were no differences"

# Test 2: Deploy (if changes exist)
npx cdk deploy

# Expected: CloudFormation changeset applied successfully
# All resources created without errors
# Outputs displayed at end

# Test 3: Verify stack outputs
aws cloudformation describe-stacks \
  --stack-name FargatePocStack \
  --query 'Stacks[0].Outputs'

# Expected outputs:
# - ALBDnsName
# - AppGenSaasRepositoryUri
# - AppGeneratorRepositoryUri
# - AppGeneratorTaskDefArn
# - S3BucketName
# - TaskSecurityGroupId
# - TaskSubnetIds
```

#### 3.2.3 Network Connectivity Test

**Purpose:** Verify ALB routes traffic to orchestrator

```bash
# Get ALB DNS name from stack outputs
ALB_DNS=$(aws cloudformation describe-stacks \
  --stack-name FargatePocStack \
  --query 'Stacks[0].Outputs[?OutputKey==`URL`].OutputValue' \
  --output text)

# Test 1: HTTP health check
curl -v http://${ALB_DNS}/health

# Expected:
# - HTTP 200 OK (or 301 redirect to HTTPS if cert configured)
# - JSON response with status: "healthy"
# - Headers show X-Forwarded-For (ALB proxy)

# Test 2: HTTPS (if certificate configured)
curl -v https://your-domain.com/health

# Expected:
# - HTTPS connection established
# - Valid SSL certificate
# - HTTP 200 OK
# - JSON response with status: "healthy"

# Test 3: WebSocket connection
wscat -c ws://${ALB_DNS}/ws

# Expected:
# - WebSocket connection established
# - No immediate disconnect
```

#### 3.2.4 Container Health Test

**Purpose:** Verify ECS tasks are healthy and registered with ALB

```bash
# Test 1: Check ECS service status
aws ecs describe-services \
  --cluster app-gen-saas-cluster \
  --services AppGenSaasService \
  --query 'services[0].[serviceName,status,runningCount,desiredCount]'

# Expected:
# - status: ACTIVE
# - runningCount: 1
# - desiredCount: 1

# Test 2: Check task health
aws ecs list-tasks \
  --cluster app-gen-saas-cluster \
  --service-name AppGenSaasService

# Get task ARN, then:
aws ecs describe-tasks \
  --cluster app-gen-saas-cluster \
  --tasks <TASK_ARN> \
  --query 'tasks[0].[lastStatus,healthStatus,containers[0].name]'

# Expected:
# - lastStatus: RUNNING
# - healthStatus: HEALTHY
# - containerName: app-gen-saas-app

# Test 3: Check ALB target health
TARGET_GROUP=$(aws elbv2 describe-target-groups \
  --names OrchestratorTargetGroup \
  --query 'TargetGroups[0].TargetGroupArn' \
  --output text)

aws elbv2 describe-target-health \
  --target-group-arn $TARGET_GROUP

# Expected:
# - State: healthy
# - Reason: - (no errors)
```

#### 3.2.5 Secrets Integration Test

**Purpose:** Verify container can access secrets from Secrets Manager

```bash
# Test 1: Check secrets exist
aws secretsmanager list-secrets \
  --query 'SecretList[?starts_with(Name, `app-gen-saas/`)].Name'

# Expected secrets:
# - app-gen-saas/supabase-url
# - app-gen-saas/supabase-anon-key
# - app-gen-saas/supabase-service-role-key
# - app-gen-saas/database-url
# - app-gen-saas/claude-oauth-token
# - app-gen-saas/github-bot-token

# Test 2: Verify task has permissions
TASK_ROLE=$(aws ecs describe-task-definition \
  --task-definition AppGenSaasTaskDef \
  --query 'taskDefinition.taskRoleArn' \
  --output text)

aws iam get-role \
  --role-name $(echo $TASK_ROLE | cut -d'/' -f2)

# Expected: Role has secretsmanager:GetSecretValue permissions

# Test 3: Check logs for secret injection errors
aws logs tail /aws/ecs/app-gen-saas-app \
  --since 5m \
  --filter-pattern "ERROR"

# Expected: No secret-related errors
```

#### 3.2.6 S3 Integration Test

**Purpose:** Verify container can write to S3 bucket

```bash
# Test 1: Check bucket exists
BUCKET=$(aws cloudformation describe-stacks \
  --stack-name FargatePocStack \
  --query 'Stacks[0].Outputs[?OutputKey==`S3BucketName`].OutputValue' \
  --output text)

aws s3 ls s3://$BUCKET/

# Expected: Bucket accessible (may be empty if no generations yet)

# Test 2: Verify task has S3 permissions
TASK_ROLE=$(aws ecs describe-task-definition \
  --task-definition AppGenSaasTaskDef \
  --query 'taskDefinition.taskRoleArn' \
  --output text)

aws iam list-role-policies --role-name $(echo $TASK_ROLE | cut -d'/' -f2)

# Expected: Policy includes s3:PutObject, s3:GetObject

# Test 3: Verify lifecycle policy
aws s3api get-bucket-lifecycle-configuration --bucket $BUCKET

# Expected:
# - Expiration: 30 days
# - Status: Enabled
```

#### 3.2.7 Task Spawning Test

**Purpose:** Verify orchestrator can spawn generator tasks

```bash
# This test requires the orchestrator to be running and handling a generation request
# It's an integration test that spans infrastructure and application

# Test via application API (see Section 3.3 for full test)
# Here we verify the INFRASTRUCTURE supports task spawning:

# Test 1: Verify orchestrator has ECS permissions
TASK_ROLE=$(aws ecs describe-task-definition \
  --task-definition AppGenSaasTaskDef \
  --query 'taskDefinition.taskRoleArn' \
  --output text)

aws iam list-role-policies --role-name $(echo $TASK_ROLE | cut -d'/' -f2)

# Expected: Policy includes ecs:RunTask, ecs:DescribeTasks

# Test 2: Verify generator task definition exists
aws ecs describe-task-definition \
  --task-definition AppGeneratorTaskDef \
  --query 'taskDefinition.[family,status,cpu,memory]'

# Expected:
# - family: AppGeneratorTaskDef
# - status: ACTIVE
# - cpu: 4096
# - memory: 8192

# Test 3: Manually spawn a generator task (infrastructure test only)
aws ecs run-task \
  --cluster app-gen-saas-cluster \
  --task-definition AppGeneratorTaskDef \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[SUBNET_IDS],securityGroups=[SG_ID],assignPublicIp=ENABLED}"

# Expected: Task ARN returned, task starts successfully
# (This task will fail quickly because no generation context provided - that's okay for infrastructure test)
```

---

### 3.3 Application Testing (app-gen-saas Repo)

**Note:** These tests are documented here for completeness but are executed in the **app-gen-saas** repository.

#### 3.3.1 Backend API Testing (curl)

**Before any frontend work, verify all API endpoints work**

```bash
# Setup: Get deployed ALB URL
API_URL="http://your-alb-dns.elb.amazonaws.com"
# or for custom domain:
API_URL="https://your-domain.com"

# Test 1: Health check (no auth required)
curl -v $API_URL/health

# Expected:
# HTTP 200 OK
# JSON: {"status":"healthy","auth":"supabase","storage":"database",...}

# Test 2: Login (get auth token)
curl -X POST $API_URL/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# Expected:
# HTTP 200 OK
# JSON: {"user":{...},"token":"..."}
# Save token for subsequent requests

TOKEN="<token-from-login>"

# Test 3: Create generation request (auth required)
curl -X POST $API_URL/api/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"prompt":"Create a simple todo list app with React and Express"}'

# Expected:
# HTTP 201 Created
# JSON: {"id":1,"userId":"...","prompt":"...","status":"queued",...}
# Save id for subsequent requests

REQUEST_ID=1

# Test 4: List generation requests
curl -X GET $API_URL/api/generations \
  -H "Authorization: Bearer $TOKEN"

# Expected:
# HTTP 200 OK
# JSON array: [{"id":1,"userId":"...","prompt":"...","status":"generating",...}]

# Test 5: Get specific generation request
curl -X GET $API_URL/api/generations/$REQUEST_ID \
  -H "Authorization: Bearer $TOKEN"

# Expected:
# HTTP 200 OK
# JSON: {"id":1,"userId":"...","prompt":"...","status":"generating|completed",...}

# Test 6: Get generation logs
curl -X GET $API_URL/api/generations/$REQUEST_ID/logs \
  -H "Authorization: Bearer $TOKEN"

# Expected:
# HTTP 200 OK
# JSON: {"requestId":1,"status":"generating","logs":"..."}

# Test 7: Download generated app (after completion)
# Wait for status to be "completed", then:
curl -X GET $API_URL/api/generations/$REQUEST_ID/download \
  -H "Authorization: Bearer $TOKEN" \
  -o generated-app.zip

# Expected:
# HTTP 200 OK
# Content-Type: application/zip (local mode)
# OR
# JSON: {"downloadUrl":"https://s3.amazonaws.com/..."} (AWS mode)

# Test 8: Error handling - Invalid prompt
curl -X POST $API_URL/api/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"prompt":"short"}'

# Expected:
# HTTP 400 Bad Request
# JSON: {"error":"Prompt must be at least 10 characters"}

# Test 9: Error handling - Unauthorized
curl -X GET $API_URL/api/generations

# Expected:
# HTTP 401 Unauthorized
# JSON: {"error":"Unauthorized"}
```

**Completion Criteria for Backend:**
- âœ… All endpoints return expected status codes
- âœ… All endpoints return expected JSON structure
- âœ… Auth middleware rejects requests without token
- âœ… Validation errors return helpful messages
- âœ… Data persists across page refreshes (database storage)

---

#### 3.3.2 Frontend Testing (Browser MCP Tools)

**After backend is verified, test complete user flows**

```bash
# Open browser and navigate to deployed application
# Using MCP browser tools:
```

**Test Flow 1: User Registration and Login**

```typescript
// 1. Open browser
mcp__browser__open_browser({ headless: false })

// 2. Navigate to application
mcp__browser__navigate_browser({ url: "https://your-domain.com" })

// Expected: Home page loads, see "Sign Up" and "Login" buttons

// 3. Click Sign Up
mcp__browser__interact_browser({
  selector: "a[href='/register']",
  interaction: "click"
})

// Expected: Navigate to /register

// 4. Fill registration form
mcp__browser__interact_browser({
  selector: "input[name='name']",
  interaction: "fill",
  value: "Test User"
})

mcp__browser__interact_browser({
  selector: "input[name='email']",
  interaction: "fill",
  value: "test@example.com"
})

mcp__browser__interact_browser({
  selector: "input[name='password']",
  interaction: "fill",
  value: "password123"
})

// 5. Submit registration
mcp__browser__interact_browser({
  selector: "button[type='submit']",
  interaction: "click"
})

// Expected: Redirect to /dashboard after successful registration

// 6. Take screenshot to verify dashboard loaded
// Expected: See user's name, "New Generation" button, empty state
```

**Test Flow 2: Create Generation Request**

```typescript
// Assuming already logged in from Flow 1

// 1. Click "New Generation" button
mcp__browser__interact_browser({
  selector: "button:has-text('New Generation')",
  interaction: "click"
})

// Expected: Generation prompt dialog/form appears

// 2. Fill generation prompt
mcp__browser__interact_browser({
  selector: "textarea[name='prompt']",
  interaction: "fill",
  value: "Create a simple todo list app with React and Express. Include add, delete, and mark as complete functionality."
})

// 3. Submit generation request
mcp__browser__interact_browser({
  selector: "button:has-text('Generate')",
  interaction: "click"
})

// Expected:
// - Dialog closes
// - New generation appears in list with status "Queued" or "Generating"
// - WebSocket updates status in real-time

// 4. Wait and verify status updates
// (WebSocket should update UI automatically)
// Take screenshot every 10 seconds to verify status changes:
// "Queued" â†’ "Generating" â†’ "Completed"

// 5. When status is "Completed", verify download button appears
mcp__browser__interact_browser({
  selector: "button:has-text('Download')",
  interaction: "click"
})

// Expected: ZIP file downloads or redirect to S3 pre-signed URL
```

**Test Flow 3: View Generation Logs**

```typescript
// 1. Click on a generation request card/row
mcp__browser__interact_browser({
  selector: ".generation-card:first-child",
  interaction: "click"
})

// Expected: Navigate to generation detail page or open detail modal

// 2. Verify logs display
// Expected: See real-time logs if generating, or final logs if completed

// 3. Take screenshot to verify logs are visible
```

**Test Flow 4: Data Persistence**

```typescript
// 1. Refresh page while logged in
mcp__browser__navigate_browser({ url: "https://your-domain.com/dashboard" })

// Expected:
// - User remains logged in (token in localStorage)
// - Generation history loads from database
// - All previously created generations visible

// 2. Logout
mcp__browser__interact_browser({
  selector: "button:has-text('Logout')",
  interaction: "click"
})

// Expected: Redirect to home page, nav shows "Login" button

// 3. Login again
mcp__browser__navigate_browser({ url: "https://your-domain.com/login" })

mcp__browser__interact_browser({
  selector: "input[name='email']",
  interaction: "fill",
  value: "test@example.com"
})

mcp__browser__interact_browser({
  selector: "input[name='password']",
  interaction: "fill",
  value: "password123"
})

mcp__browser__interact_browser({
  selector: "button[type='submit']",
  interaction: "click"
})

// Expected: Redirect to dashboard, all previous generations still visible
```

**Test Flow 5: Error Handling**

```typescript
// Test 1: Short prompt validation
mcp__browser__interact_browser({
  selector: "textarea[name='prompt']",
  interaction: "fill",
  value: "short"
})

mcp__browser__interact_browser({
  selector: "button:has-text('Generate')",
  interaction: "click"
})

// Expected: Error message "Prompt must be at least 10 characters"

// Test 2: Unauthenticated access
mcp__browser__navigate_browser({ url: "https://your-domain.com/dashboard" })
// (while logged out)

// Expected: Redirect to /login

// Test 3: Network error handling
// (Simulate by stopping backend temporarily)
// Expected: Error toast/message displays, retry button available
```

**Completion Criteria for Frontend:**
- âœ… All pages load without errors
- âœ… Navigation works (links, buttons)
- âœ… Forms submit and show validation errors
- âœ… Data displays from real API (no mock/hardcoded data)
- âœ… Loading states show during API calls
- âœ… Error states display helpful messages
- âœ… Data persists across page refreshes
- âœ… Auth state persists (localStorage token)
- âœ… WebSocket updates work in real-time

---

### 3.4 Integration Verification Checklist

**MANDATORY before declaring any feature complete:**

For each data-displaying page:

```markdown
## Dashboard Page
- [ ] Fetches data from backend using apiClient âœ…
- [ ] No placeholder/mock data âœ…
- [ ] Loading state displays during fetch âœ…
- [ ] Error state displays on failure âœ…
- [ ] Empty state displays when no data âœ…
- [ ] Data updates on WebSocket messages âœ…
- [ ] Refresh page preserves data âœ…

## Generation Detail Page
- [ ] Fetches data from backend using apiClient âœ…
- [ ] No placeholder/mock data âœ…
- [ ] Loading state displays during fetch âœ…
- [ ] Error state displays on failure âœ…
- [ ] Logs update in real-time âœ…
- [ ] Download button appears when complete âœ…
- [ ] Refresh page preserves data âœ…
```

**Red Flags (Auto-fail):**
- âŒ Using mock data instead of apiClient
- âŒ Hardcoded arrays in components
- âŒ No loading states
- âŒ Data disappears on refresh
- âŒ Auth token not used in API calls

---

## 4. Deployment Workflow

### 4.1 Prerequisites

**One-time setup:**
1. âœ… AWS CLI installed and configured
2. âœ… AWS account with appropriate permissions
3. âœ… Node.js 18+ and npm
4. âœ… Domain name (optional, for ACM certificate)

### 4.2 Initial Deployment

**Step 1: Bootstrap CDK (First Time Only)**

```bash
cd /home/ec2-user/APP_GEN/app-gen-infra
npm install

# Bootstrap CDK in AWS account
cdk bootstrap aws://ACCOUNT-ID/us-east-1
```

**Step 2: Create Secrets**

```bash
# Create all required secrets before deploying
aws secretsmanager create-secret \
  --name app-gen-saas/supabase-url \
  --secret-string "https://your-project.supabase.co"

aws secretsmanager create-secret \
  --name app-gen-saas/supabase-anon-key \
  --secret-string "your-anon-key"

aws secretsmanager create-secret \
  --name app-gen-saas/supabase-service-role-key \
  --secret-string "your-service-role-key"

aws secretsmanager create-secret \
  --name app-gen-saas/database-url \
  --secret-string "postgresql://..."

aws secretsmanager create-secret \
  --name app-gen-saas/claude-oauth-token \
  --secret-string "sk-ant-..."

aws secretsmanager create-secret \
  --name app-gen-saas/github-bot-token \
  --secret-string "ghp_..."
```

**Step 3: Deploy Infrastructure**

```bash
cd /home/ec2-user/APP_GEN/app-gen-infra

# Preview changes
cdk diff

# Deploy stack
cdk deploy

# Outputs will include:
# - ALBDnsName
# - ECR repository URIs
# - S3 bucket name
# - Task definition ARNs
```

**Step 4: Build and Push Docker Images**

See `QUICK_START_DEV_SETUP.md` for optimized EC2-based build process (2-4 min builds).

```bash
# Fast build using EC2 instance
cd ~/workspace
./fast-build.sh

# This builds and pushes both:
# - app-gen-saas-app:latest (orchestrator)
# - app-gen-saas-generator:latest (generator)
```

**Step 5: Deploy Application**

```bash
# ECS automatically pulls latest images
aws ecs update-service \
  --cluster app-gen-saas-cluster \
  --service AppGenSaasService \
  --force-new-deployment

# Wait for deployment to complete
aws ecs wait services-stable \
  --cluster app-gen-saas-cluster \
  --services AppGenSaasService
```

**Step 6: Verify Deployment**

```bash
# Get ALB URL
ALB_DNS=$(aws cloudformation describe-stacks \
  --stack-name FargatePocStack \
  --query 'Stacks[0].Outputs[?OutputKey==`URL`].OutputValue' \
  --output text)

# Test health endpoint
curl $ALB_DNS/health

# Expected: {"status":"healthy",...}
```

---

### 4.3 Daily Development Workflow

**Using EC2 for fast builds (Recommended):**

```bash
# 1. SSH/SSM into EC2
aws ssm start-session --target <INSTANCE_ID>

# 2. Pull latest code
cd ~/workspace/app-gen-saas
git pull

# 3. Build and push (2-4 minutes with cache!)
cd ~/workspace
./fast-build.sh

# 4. Deploy to ECS (2 minutes)
aws ecs update-service \
  --cluster app-gen-saas-cluster \
  --service AppGenSaasService \
  --force-new-deployment

# Total: 4-6 minutes from code change to production! ğŸš€
```

---

### 4.4 Infrastructure Updates

**When changing CDK code:**

```bash
cd /home/ec2-user/APP_GEN/app-gen-infra

# Review changes
cdk diff

# Deploy changes
cdk deploy

# CloudFormation will:
# - Create new resources
# - Update existing resources (zero-downtime when possible)
# - Delete removed resources
# - Rollback on failure
```

---

### 4.5 Secrets Management

**Updating secrets:**

```bash
# Update existing secret
aws secretsmanager update-secret \
  --secret-id app-gen-saas/supabase-url \
  --secret-string "https://new-project.supabase.co"

# Restart ECS service to pick up new secret
aws ecs update-service \
  --cluster app-gen-saas-cluster \
  --service AppGenSaasService \
  --force-new-deployment
```

**Viewing secrets (requires IAM permissions):**

```bash
# List all secrets
aws secretsmanager list-secrets \
  --query 'SecretList[?starts_with(Name, `app-gen-saas/`)].Name'

# Get secret value (use carefully - exposes sensitive data)
aws secretsmanager get-secret-value \
  --secret-id app-gen-saas/supabase-url \
  --query SecretString \
  --output text
```

---

## 5. Monitoring and Operations

### 5.1 Health Monitoring

**Check service health:**

```bash
# ECS service status
aws ecs describe-services \
  --cluster app-gen-saas-cluster \
  --services AppGenSaasService \
  --query 'services[0].[serviceName,status,runningCount,desiredCount]'

# ALB target health
aws elbv2 describe-target-health \
  --target-group-arn <TARGET_GROUP_ARN>
```

### 5.2 Log Viewing

**CloudWatch Logs:**

```bash
# Tail orchestrator logs
aws logs tail /aws/ecs/app-gen-saas-app --follow

# Tail generator logs
aws logs tail /aws/ecs/app-generator --follow

# Filter for errors
aws logs filter-log-events \
  --log-group-name /aws/ecs/app-gen-saas-app \
  --filter-pattern "ERROR"
```

### 5.3 Metrics

**Key CloudWatch metrics (auto-configured):**
- Target Response Time (request latency)
- Healthy Host Count (number of healthy tasks)
- Request Count (total requests)
- HTTP 5xx Errors (backend errors)
- ECS CPU/Memory (task resource usage)

**View metrics:**

```bash
# Via AWS Console:
# CloudWatch â†’ Metrics â†’ ECS â†’ ClusterName: app-gen-saas-cluster

# Via CLI:
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name CPUUtilization \
  --dimensions Name=ServiceName,Value=AppGenSaasService \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average
```

---

## 6. Troubleshooting Guide

### 6.1 Container Won't Start

**Symptoms:**
- ECS service shows 0 running tasks
- Tasks transition from PENDING â†’ STOPPED

**Diagnosis:**

```bash
# Get stopped task ID
aws ecs list-tasks \
  --cluster app-gen-saas-cluster \
  --desired-status STOPPED \
  --max-results 1

# Describe stopped task
aws ecs describe-tasks \
  --cluster app-gen-saas-cluster \
  --tasks <TASK_ARN>

# Check stop reason and container exit code
```

**Common Causes:**

1. **Missing secrets:**
   - Error: "Cannot retrieve secret from Secrets Manager"
   - Fix: Verify secrets exist with correct names

2. **Image pull errors:**
   - Error: "CannotPullContainerError"
   - Fix: Verify ECR repository exists and task has permissions

3. **Application crash:**
   - Error: "Essential container exited"
   - Fix: Check CloudWatch logs for application errors

### 6.2 ALB Returns 502 Bad Gateway

**Symptoms:**
- curl returns HTTP 502
- ALB is healthy but target group is unhealthy

**Diagnosis:**

```bash
# Check target health
aws elbv2 describe-target-health \
  --target-group-arn <ARN>

# Common unhealthy reasons:
# - "Target.ResponseCodeMismatch" â†’ Health check returns wrong status
# - "Target.Timeout" â†’ Health check times out
# - "Target.FailedHealthChecks" â†’ Multiple consecutive failures
```

**Common Causes:**

1. **Container not listening on port 5013:**
   - Fix: Verify app listens on PORT environment variable

2. **Health check endpoint not responding 200 OK:**
   - Fix: Verify GET /health returns {"status":"healthy"}

3. **Container crashed:**
   - Fix: Check CloudWatch logs for errors

### 6.3 Deployment Fails

**Symptoms:**
- `cdk deploy` returns error
- CloudFormation stack rollback

**Diagnosis:**

```bash
# Check CloudFormation events
aws cloudformation describe-stack-events \
  --stack-name FargatePocStack \
  --max-items 20

# Look for events with ResourceStatus=*_FAILED
```

**Common Causes:**

1. **Resource limit exceeded:**
   - Error: "Cannot exceed quota for resource type"
   - Fix: Request quota increase via AWS Support

2. **IAM permissions:**
   - Error: "User is not authorized"
   - Fix: Verify CDK execution role has necessary permissions

3. **Resource name conflicts:**
   - Error: "AlreadyExistsException"
   - Fix: Change resource names or destroy old stack first

### 6.4 Secrets Not Injected

**Symptoms:**
- Application logs show "Missing environment variable"
- Container starts but fails to connect to Supabase/database

**Diagnosis:**

```bash
# Verify task definition has secrets configured
aws ecs describe-task-definition \
  --task-definition AppGenSaasTaskDef \
  --query 'taskDefinition.containerDefinitions[0].secrets'

# Expected: Array of secret references
```

**Fix:**

1. Verify secrets exist in Secrets Manager
2. Verify task execution role has `secretsmanager:GetSecretValue` permission
3. Redeploy task definition with correct secret references

### 6.5 Generator Tasks Not Spawning

**Symptoms:**
- Generation requests stuck in "queued" status
- No generator tasks appear in ECS

**Diagnosis:**

```bash
# Check orchestrator logs
aws logs tail /aws/ecs/app-gen-saas-app --follow

# Look for errors like:
# - "AccessDenied" â†’ IAM permissions issue
# - "Invalid subnet" â†’ Network configuration issue
# - "TaskDefinition not found" â†’ Generator task def missing
```

**Fix:**

1. Verify orchestrator task role has `ecs:RunTask` permission
2. Verify `APP_GENERATOR_TASK_DEF` environment variable is set
3. Verify `TASK_SUBNETS` and `TASK_SECURITY_GROUP` are set correctly

---

## 7. Cost Estimate

**Monthly cost for MVP deployment:**

| Service | Configuration | Monthly Cost |
|---------|---------------|--------------|
| **ALB** | Always-on | $16 |
| **ECS Fargate (Orchestrator)** | 1 task, 1 vCPU, 2 GB | $15 |
| **ECS Fargate (Generator)** | 50 generations @ 15 min each | $25 |
| **CloudWatch Logs** | 5 GB/month | $5 |
| **S3 Storage** | 10 GB with 30-day lifecycle | $3 |
| **Secrets Manager** | 6 secrets | $3 |
| **Data Transfer** | 100 GB outbound | $9 |
| **Total** | | **~$76/month** |

**Cost optimizations:**
- âœ… S3 lifecycle policy (30-day deletion)
- âœ… CloudWatch log retention (1-week)
- âš ï¸ Fargate Spot for generator tasks (potential 70% savings on generator costs)
- âš ï¸ Scale down orchestrator to 0 during off-hours (if acceptable for MVP)

---

## 8. Security Checklist

**Current security posture:**

- âœ… **HTTPS only:** ALB listener on port 443 (when cert configured)
- âœ… **Container isolation:** Containers run in VPC with security groups
- âœ… **Secrets in Secrets Manager:** Never in code or environment files
- âœ… **IAM least-privilege:** Separate task roles with minimal permissions
- âœ… **Security groups:** Restrictive rules (ALB â†’ containers only)
- âœ… **Supabase RLS:** Row-level security on database
- âœ… **S3 private:** Pre-signed URLs only, no public access
- âœ… **CloudWatch logs:** All requests logged for auditing
- âœ… **Trust proxy headers:** App correctly reads X-Forwarded-Proto

**Recommended enhancements (not required for MVP):**
- âš ï¸ WAF on ALB (DDoS protection, SQL injection filtering)
- âš ï¸ VPC Flow Logs (network traffic auditing)
- âš ï¸ GuardDuty (threat detection)
- âš ï¸ Config Rules (compliance monitoring)

---

## 9. References

**Internal Documentation:**
- `docs/system-overview.md` - Authoritative system architecture
- `docs/architecture.md` - Canonical AWS deployment pattern (1034 lines)
- `docs/deployment.md` - Mandatory deployment workflow (680 lines)
- `docs/environment-configuration.md` - Environment variable patterns
- `docs/mvp-steps.md` - Quick deployment steps
- `docs/scale-steps.md` - Migration to separated pattern
- `docs/secrets-management.md` - Secrets best practices
- `QUICK_START_DEV_SETUP.md` - EC2 build optimization (563 lines)

**External References:**
- [AWS ECS Best Practices](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/)
- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [Application Load Balancer Guide](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/)
- [AWS Certificate Manager](https://docs.aws.amazon.com/acm/)

---

## 10. Conclusion

**Repository Status:** âœ… **COMPLETE AND OPERATIONAL**

This repository contains a fully functional, production-ready AWS CDK infrastructure stack for the App-Gen SaaS platform. All required features are implemented and deployed.

**No implementation work is required.** This development plan serves as:
1. âœ… Comprehensive documentation of current state
2. âœ… Testing methodology reference
3. âœ… Maintenance and troubleshooting guide
4. âœ… Knowledge transfer document

**Key Takeaways:**

1. **Infrastructure is code:** All AWS resources defined in `lib/fargate-poc-stack.ts`
2. **Secrets are secure:** AWS Secrets Manager, never in code
3. **Deployment is automated:** `cdk deploy` handles everything
4. **Monitoring is built-in:** CloudWatch Logs and Metrics
5. **Documentation is comprehensive:** See `docs/` directory

**For future development:**
- Follow `docs/deployment.md` (THE mandatory pattern)
- Use EC2 for fast builds (see `QUICK_START_DEV_SETUP.md`)
- Test infrastructure changes with `cdk diff` before deploying
- Monitor CloudWatch Logs for issues
- Refer to this plan for testing methodology

**Questions or issues?** See Section 6 (Troubleshooting) or the referenced documentation files.

---

**Document Version:** 1.0
**Last Updated:** October 24, 2025
**Maintainer:** Infrastructure Team
**Related Plans:** See `app-gen-saas` repo for application development plan
